import{r as n,j as e}from"./react-DwkAs-v9.js";import{s as P,h as R,e as H,C as _,K as g,t as ie,M as ce,P as L}from"./index-wbzsHQ-6.js";import{A as O}from"./AppToolbar-BZHSVYI7.js";import{a as W,g as se,d as de,e as I}from"./react-router-Df4HDh8c.js";import{c as oe}from"./clsx-B-dksMZM.js";import{C as me}from"./ConfirmDeleteModal-BXGAXcew.js";import{P as xe}from"./PagedTable-fW2f3xMh.js";import{e as ue,u as he,f as J}from"./QueryResponseProvider-DcusCrKV.js";import{f as pe,b as fe}from"./Query-B24ykavS.js";import{t as A,a as B}from"./formUtils-DYBw-NTu.js";import{S as ae}from"./react-bootstrap-BUaeuJHt.js";import"./apexcharts-sziEC8OT.js";import"./react-dom-DVTd-Q6a.js";import"./scheduler-CylivXx-.js";import"./axios-mH-cpkvd.js";import"./formik-B67XZPDW.js";import"./deepmerge-DhIoniG1.js";import"./lodash-es-ClCkCI8n.js";import"./react-fast-compare-0sFLRPh9.js";import"./hoist-non-react-statics-C-8QU_9G.js";import"./react-is-8JwjhRSi.js";import"./yup-BLKqc-jj.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-7gDswQQa.js";import"./react-router-dom-BJfVfmV5.js";import"./@remix-run-DUdlTjFu.js";import"./chart.js-xWmoy_ii.js";import"./@kurkle-D8fDXNIl.js";import"./@tanstack-BGZqBxWN.js";import"./react-copy-to-clipboard-C4AWj7CK.js";import"./copy-to-clipboard-BvYTofsP.js";import"./toggle-selection-BHUZwh74.js";import"./prism-react-renderer-BV8xJdsO.js";import"./react-select-Z1ywkuii.js";import"./@babel-B036hIWL.js";import"./@emotion-Cdt29Dgm.js";import"./stylis-YPZU7XtI.js";import"./@floating-ui-DZ2V_EUC.js";import"./use-isomorphic-layout-effect-CgCMJW-V.js";import"./memoize-one-DxrTgWdQ.js";import"./@popperjs-D8Kg5PqX.js";import"./react-topbar-progress-indicator-BI-R5WY2.js";import"./topbar-C3UDlew2.js";import"./bootstrap-D7dJWYZj.js";import"./classnames-Bztn78Bv.js";import"./dom-helpers-C9Bu-4wA.js";import"./@restart-rvtB3BAN.js";import"./dequal-tFQomdd2.js";import"./warning-DaFg7xBm.js";import"./prop-types-smO-eibg.js";import"./uncontrollable-C0VNg-tm.js";import"./react-transition-group-DSbRRiC3.js";import"./qs-DqtHLuEQ.js";import"./side-channel-dUox70ES.js";import"./es-errors-Jj74upKm.js";import"./object-inspect-DP5OUPBp.js";import"./side-channel-list-MmyoflM1.js";import"./side-channel-map-Bn8M9PEZ.js";import"./get-intrinsic-CU0VT1nQ.js";import"./es-object-atoms-Ditt1eQ6.js";import"./math-intrinsics-Bnyzom00.js";import"./gopd-fcd2-aIC.js";import"./es-define-property-bDCdrV83.js";import"./has-symbols-BaUvM3gb.js";import"./get-proto-BO3wE9ZV.js";import"./dunder-proto-DvTFT7MQ.js";import"./call-bind-apply-helpers-CZTuF3Zf.js";import"./function-bind-BbkWVFrm.js";import"./hasown-C2NEVhna.js";import"./call-bound-BqUCv5SB.js";import"./side-channel-weakmap-DF-x5tZ1.js";const q=s=>{var t;const a=s.name||s.username,l=a?a.trim().split(/\s+/).map(i=>{var o;return((o=i[0])==null?void 0:o.toUpperCase())??""}).join("").slice(0,2):"";return{id:s.id,username:s.username,enabled:s.enabled,roleCodes:s.roleCodes,name:a,avatar:s.avatarUrl,email:s.email,position:s.position,role:((t=s.roleCodes)==null?void 0:t.join(", "))??"",last_login:s.lastLoginAt??"",joined_day:s.joinedAt??"",two_steps:s.twoStepsEnabled??!1,online:!1,initials:{label:l,state:"primary"}}},U=[{id:"1",username:"admin",name:"系統管理員",avatarUrl:"media/avatars/300-1.jpg",email:"admin@example.com",position:"系統管理員",roleCodes:["ADMIN","UPMS_ADMIN"],enabled:!0,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2025-01-09T10:30:00+08:00",joinedAt:"2024-01-01T00:00:00+08:00"},{id:"2",username:"manager",name:"王經理",avatarUrl:"media/avatars/300-2.jpg",email:"manager@example.com",position:"營運經理",roleCodes:["MANAGER","TOM_ADMIN"],enabled:!0,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2025-01-09T09:15:00+08:00",joinedAt:"2024-03-15T00:00:00+08:00"},{id:"3",username:"operator",name:"李操作員",avatarUrl:"media/avatars/300-3.jpg",email:"operator@example.com",position:"操作員",roleCodes:["OPERATOR"],enabled:!0,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2025-01-08T16:45:00+08:00",joinedAt:"2024-06-01T00:00:00+08:00"},{id:"4",username:"driver01",name:"張司機",avatarUrl:"media/avatars/300-4.jpg",email:"driver01@example.com",position:"司機",roleCodes:["DRIVER"],enabled:!0,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2025-01-09T08:00:00+08:00",joinedAt:"2024-07-10T00:00:00+08:00"},{id:"5",username:"viewer",name:"陳查看者",avatarUrl:"media/avatars/300-5.jpg",email:"viewer@example.com",position:"查看者",roleCodes:["VIEWER"],enabled:!0,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2025-01-07T14:20:00+08:00",joinedAt:"2024-08-20T00:00:00+08:00"},{id:"6",username:"disabled_user",name:"已停用使用者",avatarUrl:"media/avatars/300-6.jpg",email:"disabled@example.com",position:"前員工",roleCodes:["OPERATOR"],enabled:!1,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2024-12-01T10:00:00+08:00",joinedAt:"2024-01-15T00:00:00+08:00"},{id:"7",username:"locked_user",name:"已鎖定使用者",avatarUrl:"media/avatars/300-7.jpg",email:"locked@example.com",position:"測試帳號",roleCodes:["OPERATOR"],enabled:!0,locked:!0,twoStepsEnabled:!1,lastLoginAt:"2025-01-05T11:30:00+08:00",joinedAt:"2024-09-01T00:00:00+08:00"},{id:"8",username:"test",name:"測試帳號",avatarUrl:"media/avatars/300-8.jpg",email:"test@example.com",position:"測試人員",roleCodes:["ADMIN","UPMS_ADMIN","TOM_ADMIN"],enabled:!0,locked:!1,twoStepsEnabled:!1,lastLoginAt:"2025-01-09T12:00:00+08:00",joinedAt:"2024-01-01T00:00:00+08:00"}],z={1:{id:"1",username:"admin",enabled:!0,locked:!1,profile:{name:"系統管理員",nickName:"Admin",email:"admin@example.com",phone:"0912-345-678",avatarUrl:"media/avatars/300-1.jpg"},roles:[{code:"ADMIN",name:"系統管理員"},{code:"UPMS_ADMIN",name:"UPMS 管理員"}],permissions:["UPMS_USER_VIEW","UPMS_USER_CREATE","UPMS_USER_UPDATE","UPMS_USER_DELETE","UPMS_ROLE_VIEW","UPMS_ROLE_CREATE","UPMS_ROLE_UPDATE","UPMS_ROLE_DELETE"],loginHistory:[{time:"2025-01-09T10:30:00+08:00",ip:"192.168.1.100",device:"Chrome on Windows"},{time:"2025-01-08T09:15:00+08:00",ip:"192.168.1.100",device:"Chrome on Windows"},{time:"2025-01-07T14:20:00+08:00",ip:"192.168.1.101",device:"Safari on macOS"}]},2:{id:"2",username:"manager",enabled:!0,locked:!1,profile:{name:"王經理",nickName:"Manager Wang",email:"manager@example.com",phone:"0923-456-789",avatarUrl:"media/avatars/300-2.jpg"},roles:[{code:"MANAGER",name:"營運經理"},{code:"TOM_ADMIN",name:"TOM 管理員"}],permissions:["TOM_ORDER_VIEW","TOM_ORDER_CREATE","TOM_ORDER_UPDATE","TOM_ORDER_ASSIGN"],loginHistory:[{time:"2025-01-09T09:15:00+08:00",ip:"192.168.1.102",device:"Firefox on Windows"},{time:"2025-01-08T08:30:00+08:00",ip:"192.168.1.102",device:"Firefox on Windows"}]},3:{id:"3",username:"operator",enabled:!0,locked:!1,profile:{name:"李操作員",nickName:"Operator Li",email:"operator@example.com",phone:"0934-567-890",avatarUrl:"media/avatars/300-3.jpg"},roles:[{code:"OPERATOR",name:"操作員"}],permissions:["TOM_ORDER_VIEW","TOM_ORDER_UPDATE"],loginHistory:[{time:"2025-01-08T16:45:00+08:00",ip:"192.168.1.103",device:"Chrome on Android"}]},4:{id:"4",username:"driver01",enabled:!0,locked:!1,profile:{name:"張司機",nickName:"Driver Zhang",email:"driver01@example.com",phone:"0945-678-901",avatarUrl:"media/avatars/300-4.jpg"},roles:[{code:"DRIVER",name:"司機"}],permissions:["TOM_ORDER_VIEW","FMS_VEHICLE_VIEW"],loginHistory:[{time:"2025-01-09T08:00:00+08:00",ip:"192.168.1.104",device:"Mobile App"}]},5:{id:"5",username:"viewer",enabled:!0,locked:!1,profile:{name:"陳查看者",nickName:"Viewer Chen",email:"viewer@example.com",phone:"0956-789-012",avatarUrl:"media/avatars/300-5.jpg"},roles:[{code:"VIEWER",name:"查看者"}],permissions:["TOM_ORDER_VIEW"],loginHistory:[{time:"2025-01-07T14:20:00+08:00",ip:"192.168.1.105",device:"Edge on Windows"}]},6:{id:"6",username:"disabled_user",enabled:!1,locked:!1,profile:{name:"已停用使用者",nickName:"Disabled User",email:"disabled@example.com",phone:"0967-890-123",avatarUrl:"media/avatars/300-6.jpg"},roles:[{code:"OPERATOR",name:"操作員"}],permissions:[],loginHistory:[{time:"2024-12-01T10:00:00+08:00",ip:"192.168.1.106",device:"Chrome on Windows"}]},7:{id:"7",username:"locked_user",enabled:!0,locked:!0,profile:{name:"已鎖定使用者",nickName:"Locked User",email:"locked@example.com",phone:"0978-901-234",avatarUrl:"media/avatars/300-7.jpg"},roles:[{code:"OPERATOR",name:"操作員"}],permissions:[],loginHistory:[{time:"2025-01-05T11:30:00+08:00",ip:"192.168.1.107",device:"Safari on iOS"}]},8:{id:"8",username:"test",enabled:!0,locked:!1,profile:{name:"測試帳號",nickName:"Test Account",email:"test@example.com",phone:"0989-012-345",avatarUrl:"media/avatars/300-8.jpg"},roles:[{code:"ADMIN",name:"系統管理員"},{code:"UPMS_ADMIN",name:"UPMS 管理員"},{code:"TOM_ADMIN",name:"TOM 管理員"}],permissions:["UPMS_USER_VIEW","UPMS_USER_CREATE","UPMS_USER_UPDATE","UPMS_USER_DELETE","TOM_ORDER_VIEW","TOM_ORDER_CREATE","TOM_ORDER_UPDATE","TOM_ORDER_DELETE"],loginHistory:[{time:"2025-01-09T12:00:00+08:00",ip:"192.168.1.108",device:"Chrome on macOS"},{time:"2025-01-08T11:00:00+08:00",ip:"192.168.1.108",device:"Chrome on macOS"},{time:"2025-01-07T10:00:00+08:00",ip:"192.168.1.108",device:"Safari on macOS"}]}},G="/api/upms/users";async function te(s,a){if(P())return console.log("[Mock] 模擬創建使用者",s),await new Promise(l=>setTimeout(l,500)),a==null||a("建立使用者成功 (Mock)","success"),!0;try{return await R.post(G,s),a==null||a("建立使用者成功","success"),!0}catch(l){return console.error(l),a==null||a("建立使用者失敗，請稍後再試","danger"),!1}}async function le(s,a){var l;if(P()){console.log("[Mock] 使用 Mock 使用者列表",s),await new Promise(p=>setTimeout(p,300));let t=[...U];if((l=s.keyword)!=null&&l.trim()){const p=s.keyword.toLowerCase();t=t.filter(y=>{var N,b;return y.username.toLowerCase().includes(p)||((N=y.name)==null?void 0:N.toLowerCase().includes(p))||((b=y.email)==null?void 0:b.toLowerCase().includes(p))})}const i=s.page||0,o=s.size||10,d=i*o,j=d+o,m=t.slice(d,j);return{content:m.map(q),totalElements:t.length,totalPages:Math.ceil(t.length/o),size:o,number:i,first:i===0,last:j>=t.length,empty:m.length===0}}try{const i=(await R.get("/api/upms/users",{params:s})).data.data;return{...i,content:(i.content||[]).map(q)}}catch(t){return console.error(t),a==null||a("取得使用者列表失敗，請稍後再試","danger"),{content:[],totalElements:0,totalPages:0,size:s.size,number:s.page,first:!0,last:!0,empty:!0}}}async function je(s,a,l){if(P()){console.log("[Mock] 模擬更新使用者",s,a),await new Promise(i=>setTimeout(i,500));const t=U.find(i=>i.id===s);return t&&(a.username&&(t.username=a.username),a.enabled!==void 0&&(t.enabled=a.enabled),a.roleCodes&&(t.roleCodes=a.roleCodes)),l==null||l("更新使用者成功 (Mock)","success"),t?q(t):null}try{const t=await R.put(`/api/upms/users/${s}`,a);return l==null||l("更新使用者成功","success"),t.data.data}catch(t){throw console.error(t),l==null||l("更新使用者失敗，請稍後再試","danger"),t}}async function be(s,a){if(P()){console.log("[Mock] 模擬刪除使用者",s),await new Promise(t=>setTimeout(t,500));const l=U.findIndex(t=>t.id===s);return l!==-1&&(U.splice(l,1),delete z[s]),a==null||a("刪除使用者成功 (Mock)","success"),!0}try{return await R.delete(`/api/upms/users/${s}`),a==null||a("刪除使用者成功","success"),!0}catch(l){return console.error(l),a==null||a("刪除使用者失敗，請稍後再試","danger"),!1}}async function ge(s,a){await R.patch(`/api/upms/users/${s}`,a)}async function ne(s,a){if(P()){console.log("[Mock] 使用 Mock 使用者詳情",s),await new Promise(t=>setTimeout(t,300));const l=z[s];return l?{...l,loginHistory:l.loginHistory??[]}:null}try{const t=(await R.get(`/api/upms/users/${s}/profile`)).data.data;return{...t,loginHistory:t.loginHistory??[]}}catch(l){return console.error(l),null}}async function Ne(s,a,l){if(P())return console.log("[Mock] 模擬重設密碼",s),await new Promise(t=>setTimeout(t,500)),l==null||l("密碼已成功重設 (Mock)","success"),!0;try{return await R.patch(`/api/upms/users/${s}/password`,null,{params:{newPassword:a}}),l==null||l("密碼已成功重設","success"),!0}catch(t){return console.error(t),l==null||l("重設密碼失敗，請稍後再試","danger"),!1}}async function ve(s,a,l){if(P()){console.log("[Mock] 模擬更新使用者狀態",s,a),await new Promise(o=>setTimeout(o,500));const t=U.find(o=>o.id===s),i=z[s];return t&&i&&(a.enabled!==void 0&&(t.enabled=a.enabled,i.enabled=a.enabled),a.locked!==void 0&&(t.locked=a.locked,i.locked=a.locked)),l==null||l("更新使用者狀態成功 (Mock)","success"),i?{...i}:null}try{return(await R.patch(`${G}/${s}/status`,a)).data.data}catch(t){return console.error(t),l==null||l("更新使用者狀態失敗，請稍後再試","danger"),null}}async function ye(s,a){var l;if(P()){console.log("[Mock] 使用 Mock 使用者權限",s),await new Promise(i=>setTimeout(i,200));const t=z[s];return(t==null?void 0:t.permissions)??[]}try{return((l=(await R.get(`${G}/${s}/permissions`)).data.data)==null?void 0:l.permissions)??[]}catch(t){return console.error(t),a==null||a("取得權限摘要失敗（已改用快取資料）","warning"),[]}}const we=()=>{var v;const s=W(),{alert:a,showAlert:l,Alert:t}=H(),[i,o]=n.useState(!0),[d,j]=n.useState([]),m=n.useCallback(async()=>{o(!0);try{const c=await le({page:0,size:1e3},l);j(c.content||[])}catch(c){console.error(c),l("載入使用者資料失敗","danger")}finally{o(!1)}},[l]);n.useEffect(()=>{m()},[m]);const u=n.useMemo(()=>{const c=d.length,x=d.filter(C=>C.enabled).length,f=c-x,k=d.filter(C=>{const M=U.find(h=>h.id===C.id);return(M==null?void 0:M.locked)??!1}).length,r=d.reduce((C,M)=>{var h;return C+(((h=M.roleCodes)==null?void 0:h.length)??0)},0),S=c>0?Math.round(r/c):0;return{total:c,enabled:x,disabled:f,locked:k,totalRoles:r,avgRoles:S}},[d]),p=n.useMemo(()=>P()?d.map(x=>{const f=U.find(k=>k.id===x.id);return{...x,joinedAt:(f==null?void 0:f.joinedAt)??void 0}}).sort((x,f)=>!x.joinedAt&&!f.joinedAt?0:x.joinedAt?f.joinedAt?new Date(f.joinedAt).getTime()-new Date(x.joinedAt).getTime():-1:1).slice(0,5):[...d].sort((c,x)=>!c.joined_day&&!x.joined_day?0:c.joined_day?x.joined_day?new Date(x.joined_day).getTime()-new Date(c.joined_day).getTime():-1:1).slice(0,5),[d]),y=n.useMemo(()=>{const c={0:0,1:0,2:0,3:0,"4+":0};return d.forEach(x=>{var k;const f=((k=x.roleCodes)==null?void 0:k.length)??0;f===0?c[0]++:f===1?c[1]++:f===2?c[2]++:f===3?c[3]++:c["4+"]++}),c},[d]),N=c=>{if(!c)return"-";try{const x=new Date(c);return Number.isNaN(x.getTime())?c:x.toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return c}},b=c=>c?e.jsx("span",{className:"badge badge-light-success",children:"啟用"}):e.jsx("span",{className:"badge badge-light-secondary",children:"停用"}),w=()=>{m()};return e.jsxs(_,{children:[a&&e.jsx(t,{message:a.message,type:a.type}),e.jsx(O,{title:"使用者總覽",breadcrumbs:[{label:"權限管理",href:"#",active:!1},{label:"使用者",active:!0}]}),e.jsx("div",{className:"app-container container-fluid",children:i?e.jsx("div",{className:"d-flex justify-content-center py-10",children:e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"載入中..."})})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row g-5 g-xl-8 mb-5 mb-xl-10",children:[e.jsx("div",{className:"col-12 col-sm-6 col-xl-3",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("span",{className:"text-muted fw-semibold fs-7",children:"使用者總數"}),e.jsx("span",{className:"fw-bold fs-2 text-gray-900 mt-1",children:u.total})]}),e.jsx("span",{className:"badge badge-light-primary p-3",children:e.jsx(g,{iconName:"abstract-27",className:"fs-2"})})]}),e.jsx("div",{className:"separator my-4"}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("span",{className:"text-muted fs-8",children:"已啟用"}),e.jsx("span",{className:"fw-bold text-gray-800",children:u.enabled})]})]})})}),e.jsx("div",{className:"col-12 col-sm-6 col-xl-3",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("span",{className:"text-muted fw-semibold fs-7",children:"啟用使用者"}),e.jsx("span",{className:"fw-bold fs-2 text-gray-900 mt-1",children:u.enabled})]}),e.jsx("span",{className:"badge badge-light-success p-3",children:e.jsx(g,{iconName:"check-circle",className:"fs-2"})})]}),e.jsx("div",{className:"separator my-4"}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("span",{className:"text-muted fs-8",children:"停用"}),e.jsx("span",{className:"fw-bold text-gray-800",children:u.disabled})]})]})})}),e.jsx("div",{className:"col-12 col-sm-6 col-xl-3",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("span",{className:"text-muted fw-semibold fs-7",children:"鎖定使用者"}),e.jsx("span",{className:"fw-bold fs-2 text-gray-900 mt-1",children:u.locked})]}),e.jsx("span",{className:"badge badge-light-danger p-3",children:e.jsx(g,{iconName:"lock",className:"fs-2"})})]}),e.jsx("div",{className:"separator my-4"}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("span",{className:"text-muted fs-8",children:"平均角色數"}),e.jsxs("span",{className:"fw-bold text-gray-800",children:[u.avgRoles," 個/使用者"]})]})]})})}),e.jsx("div",{className:"col-12 col-sm-6 col-xl-3",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("span",{className:"text-muted fw-semibold fs-7",children:"最近加入"}),e.jsxs("span",{className:"fw-bold fs-2 text-gray-900 mt-1",children:[p.length," 個"]})]}),e.jsx("span",{className:"badge badge-light-warning p-3",children:e.jsx(g,{iconName:"time",className:"fs-2"})})]}),e.jsx("div",{className:"separator my-4"}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("span",{className:"text-muted fs-8",children:"加入時間"}),e.jsx("span",{className:"fw-bold text-gray-800",children:p.length>0?N(P()?((v=U.find(c=>c.id===p[0].id))==null?void 0:v.joinedAt)??void 0:p[0].joined_day??void 0):"-"})]})]})})})]}),e.jsxs("div",{className:"row g-5 g-xl-8",children:[e.jsx("div",{className:"col-12 col-xl-6",children:e.jsxs("div",{className:"card h-100",children:[e.jsx("div",{className:"card-header border-0 pt-6",children:e.jsxs("h3",{className:"card-title align-items-start flex-column",children:[e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"角色數量分布"}),e.jsx("span",{className:"text-muted mt-1 fw-semibold fs-7",children:"各使用者擁有的角色數量統計"})]})}),e.jsx("div",{className:"card-body pt-0",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"fw-bold text-muted",children:[e.jsx("th",{className:"min-w-150px",children:"角色數量"}),e.jsx("th",{className:"min-w-100px text-end",children:"使用者數量"}),e.jsx("th",{className:"min-w-150px",children:"比例"})]})}),e.jsx("tbody",{children:Object.entries(y).map(([c,x])=>{const f=u.total>0?Math.round(x/u.total*100):0;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("span",{className:"text-gray-800 fw-bold",children:c==="0"?"無角色":c==="4+"?"4 個以上":`${c} 個`})}),e.jsx("td",{className:"text-end",children:e.jsx("span",{className:"fw-bold text-gray-900",children:x})}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"progress w-100 me-3",style:{height:"8px"},children:e.jsx("div",{className:"progress-bar bg-primary",role:"progressbar",style:{width:`${f}%`},"aria-valuenow":f,"aria-valuemin":0,"aria-valuemax":100})}),e.jsxs("span",{className:"text-muted fs-7 fw-bold min-w-50px text-end",children:[f,"%"]})]})})]},c)})})]})})})]})}),e.jsx("div",{className:"col-12 col-xl-6",children:e.jsxs("div",{className:"card h-100",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsxs("h3",{className:"card-title align-items-start flex-column",children:[e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"最近加入的使用者"}),e.jsx("span",{className:"text-muted mt-1 fw-semibold fs-7",children:"最近加入的 5 個使用者"})]}),e.jsx("div",{className:"card-toolbar",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-light-primary",onClick:()=>s("/upms/user/list"),children:["查看全部",e.jsx(g,{iconName:"arrow-right",className:"fs-4 ms-1"})]})})]}),e.jsx("div",{className:"card-body pt-0",children:p.length===0?e.jsxs("div",{className:"text-center py-10 text-muted",children:[e.jsx(g,{iconName:"information-5",className:"fs-2x text-muted mb-3"}),e.jsx("p",{className:"mb-0",children:"尚無使用者資料"})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"fw-bold text-muted",children:[e.jsx("th",{className:"min-w-150px",children:"使用者名稱"}),e.jsx("th",{className:"min-w-150px",children:"帳號"}),e.jsx("th",{className:"min-w-100px",children:"角色數"}),e.jsx("th",{className:"min-w-100px",children:"狀態"}),e.jsx("th",{className:"min-w-100px text-end",children:"操作"})]})}),e.jsx("tbody",{children:p.map(c=>{var x;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("span",{className:"text-gray-800 fw-bold",children:c.name||c.username})}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-light-info fs-7 fw-bold",children:c.username})}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-light-primary",children:((x=c.roleCodes)==null?void 0:x.length)??0})}),e.jsx("td",{children:b(c.enabled)}),e.jsx("td",{className:"text-end",children:e.jsx("button",{type:"button",className:"btn btn-sm btn-light-primary",onClick:()=>s(`/upms/user/${c.id}/detail`),children:"詳情"})})]},c.id)})})]})})})]})})]}),e.jsx("div",{className:"row g-5 g-xl-8 mt-1",children:e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header border-0 pt-6",children:e.jsx("h3",{className:"card-title align-items-start flex-column",children:e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"快速操作"})})}),e.jsx("div",{className:"card-body pt-0",children:e.jsxs("div",{className:"d-flex flex-wrap gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>s("/upms/user/create"),children:[e.jsx(g,{iconName:"plus",className:"fs-2 me-2"}),"新增使用者"]}),e.jsxs("button",{type:"button",className:"btn btn-light-primary",onClick:()=>s("/upms/user/list"),children:[e.jsx(g,{iconName:"list",className:"fs-2 me-2"}),"查看所有使用者"]}),e.jsxs("button",{type:"button",className:"btn btn-light",onClick:w,children:[e.jsx(g,{iconName:"arrows-circle",className:"fs-2 me-2"}),"刷新"]})]})})]})})})]})})]})},ke=10,Ce=s=>{if(!s)return"-";try{const a=new Date(s);if(Number.isNaN(a.getTime()))return s;const l=a.getFullYear(),t=String(a.getMonth()+1).padStart(2,"0"),i=String(a.getDate()).padStart(2,"0"),o=String(a.getHours()).padStart(2,"0"),d=String(a.getMinutes()).padStart(2,"0");return`${l}/${t}/${i} ${o}:${d}`}catch{return s}},Se=s=>{if(!s)return"-";try{const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return s}},Ee=({searchKeyword:s,showAlert:a,roles:l,onEdit:t})=>{const i=W(),[o,d]=n.useState([]),[j,m]=n.useState(0),[u,p]=n.useState(1),[y,N]=n.useState(1),[b,w]=n.useState(!1),[v,c]=n.useState(null),[x,f]=n.useState(!1),k=n.useCallback(async()=>{w(!0);try{const h={page:y-1,size:ke,keyword:s!=null&&s.trim()?s.trim():void 0},D=await le(h,a);d(D.content),m(D.totalElements),p(D.totalPages||1)}finally{w(!1)}},[y,s,a]);n.useEffect(()=>{N(1)},[s]),n.useEffect(()=>{k()},[k]);const r=n.useCallback(h=>{i(`/upms/user/${h.id}/detail`)},[i]),S=h=>c(h),C=async()=>{if(!v)return;const h=v.id;if(!h){a("缺少使用者識別碼，無法刪除","danger");return}try{f(!0),await be(String(h),a)&&(await k(),c(null))}finally{f(!1)}},M=[{header:"使用者",className:"min-w-200px"},{header:"角色",className:"min-w-125px"},{header:"狀態",className:"min-w-100px"},{header:"最後登入",className:"min-w-125px"},{header:"加入日期",className:"min-w-125px"},{header:"操作",className:"text-end min-w-100px"}];return e.jsxs(e.Fragment,{children:[e.jsx(xe,{columns:M,rows:o,loading:b,emptyText:"沒有使用者資料",page:y,totalPages:u,totalElements:j,onPrev:()=>N(h=>Math.max(1,h-1)),onNext:()=>N(h=>Math.min(u||1,h+1)),tableClassName:"table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer",renderRow:h=>{var D,Y,Q,Z,X;return e.jsxs("tr",{className:"cursor-pointer table-row-hover text-gray-600 fw-bold",onClick:()=>r(h),children:[e.jsx("td",{children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"symbol symbol-circle symbol-50px overflow-hidden me-3",children:e.jsx("a",{href:"#",onClick:E=>{E.preventDefault(),E.stopPropagation(),r(h)},children:h.avatar?e.jsx("div",{className:"symbol-label",children:e.jsx("img",{src:ie(`media/${h.avatar}`),alt:h.name,className:"w-100"})}):e.jsx("div",{className:oe("symbol-label fs-3",`bg-light-${((D=h.initials)==null?void 0:D.state)||"primary"}`,`text-${((Y=h.initials)==null?void 0:Y.state)||"primary"}`),children:((Q=h.initials)==null?void 0:Q.label)||((X=(Z=h.name)==null?void 0:Z.charAt(0))==null?void 0:X.toUpperCase())||"U"})})}),e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("a",{href:"#",className:"text-gray-800 text-hover-primary mb-1",onClick:E=>{E.preventDefault(),E.stopPropagation(),r(h)},children:h.name||h.username}),e.jsx("span",{className:"text-muted fs-7",children:h.email||h.username})]})]})}),e.jsx("td",{children:h.roleCodes&&h.roleCodes.length>0?e.jsxs("div",{className:"d-flex flex-wrap gap-1",children:[h.roleCodes.slice(0,2).map((E,re)=>e.jsx("span",{className:"badge badge-light-info fs-7 fw-bold",children:E},re)),h.roleCodes.length>2&&e.jsxs("span",{className:"badge badge-light fs-7 fw-bold",children:["+",h.roleCodes.length-2]})]}):e.jsx("span",{className:"text-muted fs-7",children:"未分配角色"})}),e.jsx("td",{children:h.enabled?e.jsx("span",{className:"badge badge-light-success fw-bolder",children:"啟用"}):e.jsx("span",{className:"badge badge-light-secondary fw-bolder",children:"停用"})}),e.jsx("td",{children:h.last_login?e.jsx("div",{className:"badge badge-light fw-bolder",children:Ce(h.last_login)}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:h.joined_day?e.jsx("span",{className:"text-gray-800 fw-bold",children:Se(h.joined_day)}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{className:"text-end",onClick:E=>E.stopPropagation(),children:e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx("button",{className:"btn btn-light-primary btn-sm",onClick:E=>{E.preventDefault(),r(h)},title:"查看詳情",children:e.jsx(g,{iconName:"eye",className:"fs-2"})}),e.jsx("button",{className:"btn btn-light-warning btn-sm",onClick:E=>{E.preventDefault(),t(h)},title:"編輯",children:e.jsx(g,{iconName:"message-edit",className:"fs-2"})}),e.jsx("button",{className:"btn btn-light-danger btn-sm",onClick:E=>{E.preventDefault(),S(h)},title:"刪除",children:e.jsx(g,{iconName:"trash",className:"fs-2"})})]})})]},h.id)}}),v&&e.jsx(me,{open:!!v,title:"刪除使用者",deleting:x,message:e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["確定要刪除使用者 ",e.jsx("strong",{children:v.username})," 嗎？"]}),e.jsx("p",{className:"text-muted mb-0",children:"此操作無法復原，請再次確認。"})]}),onClose:()=>x?null:c(null),onConfirm:C})]})},Te=()=>{const{updateState:s}=ue(),{isLoading:a}=he(),[l,t]=n.useState(),[i,o]=n.useState();n.useEffect(()=>{ce.reinitialization()},[]);const d=()=>{s({filter:void 0,...J})},j=()=>{s({filter:{role:l,last_login:i},...J})};return e.jsxs(e.Fragment,{children:[e.jsxs("button",{disabled:a,type:"button",className:"btn btn-light-primary me-3","data-kt-menu-trigger":"click","data-kt-menu-placement":"bottom-end",children:[e.jsx(g,{iconName:"filter",className:"fs-2"}),"Filter"]}),e.jsxs("div",{className:"menu menu-sub menu-sub-dropdown w-300px w-md-325px","data-kt-menu":"true",children:[e.jsx("div",{className:"px-7 py-5",children:e.jsx("div",{className:"fs-5 text-gray-900 fw-bolder",children:"Filter Options"})}),e.jsx("div",{className:"separator border-gray-200"}),e.jsxs("div",{className:"px-7 py-5","data-kt-user-table-filter":"form",children:[e.jsxs("div",{className:"mb-10",children:[e.jsx("label",{className:"form-label fs-6 fw-bold",children:"Role:"}),e.jsxs("select",{className:"form-select form-select-solid fw-bolder","data-kt-select2":"true","data-placeholder":"Select option","data-allow-clear":"true","data-kt-user-table-filter":"role","data-hide-search":"true",onChange:m=>t(m.target.value),value:l,children:[e.jsx("option",{value:""}),e.jsx("option",{value:"Administrator",children:"Administrator"}),e.jsx("option",{value:"Analyst",children:"Analyst"}),e.jsx("option",{value:"Developer",children:"Developer"}),e.jsx("option",{value:"Support",children:"Support"}),e.jsx("option",{value:"Trial",children:"Trial"})]})]}),e.jsxs("div",{className:"mb-10",children:[e.jsx("label",{className:"form-label fs-6 fw-bold",children:"Last login:"}),e.jsxs("select",{className:"form-select form-select-solid fw-bolder","data-kt-select2":"true","data-placeholder":"Select option","data-allow-clear":"true","data-kt-user-table-filter":"two-step","data-hide-search":"true",onChange:m=>o(m.target.value),value:i,children:[e.jsx("option",{value:""}),e.jsx("option",{value:"Yesterday",children:"Yesterday"}),e.jsx("option",{value:"20 mins ago",children:"20 mins ago"}),e.jsx("option",{value:"5 hours ago",children:"5 hours ago"}),e.jsx("option",{value:"2 days ago",children:"2 days ago"})]})]}),e.jsxs("div",{className:"d-flex justify-content-end",children:[e.jsx("button",{type:"button",disabled:a,onClick:j,className:"btn btn-light btn-active-light-primary fw-bold me-2 px-6","data-kt-menu-dismiss":"true","data-kt-user-table-filter":"reset",children:"Reset"}),e.jsx("button",{disabled:a,type:"button",onClick:d,className:"btn btn-primary fw-bold px-6","data-kt-menu-dismiss":"true","data-kt-user-table-filter":"filter",children:"Apply"})]})]})]})]})},K=s=>s.trim().toLowerCase(),Me=({open:s,onClose:a,onSaved:l,showAlert:t,roles:i,editingUser:o})=>{const d=!!o,[j,m]=n.useState(""),[u,p]=n.useState(""),[y,N]=n.useState(!0),[b,w]=n.useState([]),[v,c]=n.useState(!1);n.useEffect(()=>{if(s){if(!o){m(""),p(""),N(!0),w([]);return}m(o.username??""),p(""),N(!!o.enabled),w(o.roleCodes??[])}},[s,o]);const x=r=>{w(S=>S.includes(r)?S.filter(C=>C!==r):[...S,r])},f=()=>K(j)?!d&&!u.trim()?(t("請輸入初始密碼（password）","warning"),!1):b.length?!0:(t("請至少選擇 1 個角色（roleCodes）","warning"),!1):(t("請輸入帳號（username）","warning"),!1),k=async()=>{if(f())try{if(c(!0),d&&o){const r={username:K(j),enabled:y,roleCodes:b};await je(o.id,r,t)}else{const r={username:K(j),password:u.trim(),roleCodes:b};await te(r,t)}l()}catch(r){console.error(r),t("儲存失敗，請稍後再試","danger")}finally{c(!1)}};return s?e.jsx("div",{className:"modal fade show d-block",tabIndex:-1,style:{backgroundColor:"rgba(0,0,0,.25)"},role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx(g,{iconName:d?"message-edit":"plus",className:"fs-2 me-2"}),d?"編輯使用者":"新增使用者"]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-light",onClick:a,disabled:v,"aria-label":"Close",children:"×"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row g-5",children:[e.jsxs("div",{className:"col-12 col-md-6 d-flex flex-column gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label required",children:"帳號（username）"}),e.jsx("input",{className:"form-control",value:j,onChange:r=>m(r.target.value),placeholder:"例如：admin",autoFocus:!0}),e.jsx("div",{className:"text-muted fs-8 mt-1",children:"會自動 trim + lower（避免 Admin / admin 重複）"})]}),!d&&e.jsxs("div",{children:[e.jsx("label",{className:"form-label required",children:"初始密碼（password）"}),e.jsx("input",{className:"form-control",type:"password",value:u,onChange:r=>p(r.target.value),placeholder:"請輸入初始密碼"})]}),e.jsxs("div",{className:"form-check form-switch form-check-custom form-check-solid",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"userEnabledSwitch",checked:y,onChange:r=>N(r.target.checked)}),e.jsx("label",{className:"form-check-label",htmlFor:"userEnabledSwitch",children:"啟用"})]})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label required",children:"角色（至少 1）"}),e.jsx("div",{className:"border rounded p-3",style:{maxHeight:260,overflowY:"auto"},children:i.length===0?e.jsx("div",{className:"text-muted",children:"目前尚無角色資料"}):i.map(r=>e.jsxs("label",{className:"form-check form-check-sm form-check-custom mb-2",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",checked:b.includes(r.code),onChange:()=>x(r.code)}),e.jsxs("span",{className:"form-check-label",children:[r.code," - ",r.name]})]},r.id))})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-light",onClick:a,disabled:v,children:"取消"}),e.jsx("button",{className:"btn btn-primary",onClick:k,disabled:v,children:v?"儲存中…":"儲存"})]})]})})}):null};function Pe(){const{alert:s,showAlert:a,Alert:l}=H(),t=W(),[i,o]=n.useState(""),[d,j]=n.useState(""),[m,u]=n.useState(0),[p,y]=n.useState([]),[N,b]=n.useState(!1),[w,v]=n.useState(null),c=r=>{r.key==="Enter"&&o(d.trim())},x=()=>{u(r=>r+1),b(!1),v(null)},f=()=>{t("/upms/user/create")},k=r=>{v(r),b(!0)};return n.useEffect(()=>{(async()=>{const C=await pe({page:0,size:100,keyword:void 0},a);y(Array.isArray(C)?C:[])})()},[a]),e.jsxs(_,{children:[s&&e.jsx(l,{message:s.message,type:s.type}),e.jsx(O,{title:"使用者列表",breadcrumbs:[{label:"權限管理",href:"#"},{label:"使用者",active:!0}]}),e.jsx("div",{className:"flex-column-fluid",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsx("div",{className:"card-title",children:e.jsxs("div",{className:"d-flex align-items-center position-relative my-1",children:[e.jsx(g,{iconName:"magnifier",className:"fs-1 position-absolute ms-6"}),e.jsx("input",{type:"text",className:"form-control form-control-solid w-250px ps-14",placeholder:"搜尋使用者...",value:d,onChange:r=>j(r.target.value),onKeyDown:c})]})}),e.jsx("div",{className:"card-toolbar",children:e.jsxs("div",{className:"d-flex justify-content-end gap-2","data-kt-user-table-toolbar":"base",children:[e.jsx(Te,{}),e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:f,children:[e.jsx(g,{iconName:"plus",className:"fs-2"}),"新增使用者"]})]})})]}),e.jsx("div",{className:"card-body py-4",children:e.jsx(Ee,{searchKeyword:i,showAlert:a,roles:p,onEdit:k},m)})]})}),e.jsx(Me,{open:N,onClose:()=>{b(!1),v(null)},showAlert:a,roles:p,editingUser:w,onSaved:x})]})}const Re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,V=s=>(s??"").trim(),Ue=({submitting:s=!1,onSubmit:a,onCancel:l})=>{const[t,i]=n.useState({username:"",password:"",confirmPassword:"",roleCodes:[],name:"",email:"",phone:""}),[o,d]=n.useState([]),[j,m]=n.useState(!1),[u,p]=n.useState({}),[y,N]=n.useState(!1);n.useEffect(()=>{let r=!0;return(async()=>{m(!0);try{const C=await fe();if(!r)return;d(C)}finally{r&&m(!1)}})(),()=>{r=!1}},[]);const b=n.useMemo(()=>{const r={},S=V(t.username),C=V(t.password),M=V(t.confirmPassword),h=V(t.email);return S||(r.username="帳號為必填"),C||(r.password="密碼為必填"),M||(r.confirmPassword="請再次輸入密碼"),C&&M&&C!==M&&(r.confirmPassword="兩次密碼輸入不一致"),(t.roleCodes??[]).length===0&&(r.roleCodes="至少需選擇 1 個角色"),h&&!Re.test(h)&&(r.email="Email 格式不正確"),r},[t]),w=r=>(y||u[r])&&!!b[r],v=r=>w(r)?"is-invalid":"",c=r=>S=>i(C=>({...C,[r]:S.target.value})),x=r=>()=>p(S=>({...S,[r]:!0})),f=r=>{const S=Array.from(r.target.selectedOptions).map(C=>C.value);i(C=>({...C,roleCodes:S}))},k=async r=>{r.preventDefault(),N(!0),!Object.keys(b).length&&await a(t)};return e.jsxs("form",{onSubmit:k,className:"form",children:[e.jsxs("div",{className:"row g-5 mb-5",children:[e.jsxs("div",{className:"col-12 col-lg-6",children:[e.jsxs("label",{className:"form-label required fw-bold fs-6 text-gray-700 mb-2",children:["帳號 ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",className:`form-control form-control-solid ${v("username")}`,placeholder:"例如：admin",value:t.username,onChange:c("username"),onBlur:x("username"),autoComplete:"off",disabled:s}),w("username")&&e.jsx("div",{className:"invalid-feedback",children:b.username})]}),e.jsxs("div",{className:"col-12 col-lg-6",children:[e.jsx("label",{className:"form-label fw-bold fs-6 text-gray-700 mb-2",children:"顯示名稱"}),e.jsx("input",{type:"text",className:"form-control form-control-solid",placeholder:"例如：王小明",value:t.name??"",onChange:c("name"),disabled:s})]})]}),e.jsxs("div",{className:"row g-5 mb-5",children:[e.jsxs("div",{className:"col-12 col-lg-6",children:[e.jsxs("label",{className:"form-label required fw-bold fs-6 text-gray-700 mb-2",children:["初始密碼 ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"password",className:`form-control form-control-solid ${v("password")}`,placeholder:"請輸入初始密碼",value:t.password,onChange:c("password"),onBlur:x("password"),autoComplete:"new-password",disabled:s}),w("password")&&e.jsx("div",{className:"invalid-feedback",children:b.password})]}),e.jsxs("div",{className:"col-12 col-lg-6",children:[e.jsxs("label",{className:"form-label required fw-bold fs-6 text-gray-700 mb-2",children:["確認密碼 ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"password",className:`form-control form-control-solid ${v("confirmPassword")}`,placeholder:"請再次輸入密碼",value:t.confirmPassword,onChange:c("confirmPassword"),onBlur:x("confirmPassword"),autoComplete:"new-password",disabled:s}),w("confirmPassword")&&e.jsx("div",{className:"invalid-feedback",children:b.confirmPassword})]})]}),e.jsxs("div",{className:"row g-5 mb-5",children:[e.jsxs("div",{className:"col-12 col-lg-6",children:[e.jsx("label",{className:"form-label fw-bold fs-6 text-gray-700 mb-2",children:"Email"}),e.jsx("input",{type:"email",className:`form-control form-control-solid ${v("email")}`,placeholder:"example@company.com",value:t.email??"",onChange:c("email"),onBlur:x("email"),disabled:s}),w("email")&&e.jsx("div",{className:"invalid-feedback",children:b.email})]}),e.jsxs("div",{className:"col-12 col-lg-6",children:[e.jsx("label",{className:"form-label fw-bold fs-6 text-gray-700 mb-2",children:"電話"}),e.jsx("input",{type:"tel",className:"form-control form-control-solid",placeholder:"例如：0912-345-678",value:t.phone??"",onChange:c("phone"),disabled:s})]})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("label",{className:"form-label required fw-bold fs-6 text-gray-700 mb-2",children:["角色 ",e.jsx("span",{className:"text-danger",children:"*"})," ",t.roleCodes.length>0&&e.jsxs("span",{className:"badge badge-light-info ms-2",children:["已選 ",t.roleCodes.length," 個"]})]}),e.jsx("select",{className:`form-select form-select-solid ${v("roleCodes")}`,multiple:!0,value:t.roleCodes??[],onChange:f,onBlur:x("roleCodes"),disabled:s||j,style:{minHeight:100},children:o.length===0?e.jsx("option",{value:"",disabled:!0,children:j?"載入角色中…":"（目前沒有可選角色）"}):o.map(r=>e.jsxs("option",{value:r.code,children:[r.code,"（",r.name,"）"]},r.code))}),w("roleCodes")&&e.jsx("div",{className:"invalid-feedback d-block",children:b.roleCodes}),e.jsxs("div",{className:"form-text text-muted fs-7 mt-2",children:["按住 ",e.jsx("kbd",{className:"badge badge-light-primary fs-8",children:"⌘"}),"（Mac）或"," ",e.jsx("kbd",{className:"badge badge-light-primary fs-8",children:"Ctrl"}),"（Windows）可多選"]})]}),e.jsxs("div",{className:"d-flex justify-content-end gap-3 pt-5 border-top",children:[e.jsx("button",{type:"button",className:"btn btn-light btn-active-light-primary",onClick:l,disabled:s,children:"取消"}),e.jsxs("button",{type:"submit",className:"btn btn-primary",disabled:s,children:[s&&e.jsx("span",{className:"spinner-border spinner-border-sm align-middle me-2"}),s?"建立中...":"建立使用者"]})]})]})},De=s=>({username:A(s.username),password:A(s.password),roleCodes:s.roleCodes,name:B(s.name),email:B(s.email),phone:B(s.phone)}),_e=()=>{const s=W(),{alert:a,showAlert:l,Alert:t}=H(),[i,o]=n.useState(!1),d=n.useCallback(()=>{s(-1)},[s]),j=n.useCallback(async m=>{o(!0);try{if(await te(De(m),l)){s("/upms/user/overview");return}}catch(u){console.error(u),l("系統發生錯誤，請稍後再試","danger")}finally{o(!1)}},[s,l]);return e.jsxs(_,{children:[a&&e.jsx(t,{message:a.message,type:a.type}),e.jsx(O,{title:"新增使用者",breadcrumbs:[{label:"權限管理",href:"#",active:!1},{label:"使用者",href:"/upms/user/list",active:!1},{label:"新增",active:!0}]}),e.jsx("div",{className:"flex-column-fluid",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsx("div",{className:"card-title",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(g,{iconName:"user",className:"fs-2 me-2 text-primary"}),e.jsx("h2",{className:"fw-bold text-gray-900 m-0",children:"建立新使用者"})]})}),e.jsx("div",{className:"card-toolbar",children:e.jsxs("button",{type:"button",className:"btn btn-light btn-active-light-primary",onClick:d,disabled:i,children:[e.jsx(g,{iconName:"arrow-left",className:"fs-2"}),"返回"]})})]}),e.jsx("div",{className:"card-body py-6",children:e.jsx(Ue,{submitting:i,onSubmit:j,onCancel:d})})]})})]})},$=s=>s==null||s===""?"-":String(s),T=s=>s.trim(),Oe=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s),Le=s=>/^[0-9+\-()\s]{6,20}$/.test(s),ee=s=>{const a=T(s.name),l=T(s.email),t=T(s.phone);if(!a)return"姓名不可為空";if(a.length>128)return"姓名長度不可超過 128";if(l){if(l.length>128)return"Email 長度不可超過 128";if(!Oe(l))return"Email 格式不正確"}if(t){if(t.length>32)return"手機長度不可超過 32";if(!Le(t))return"手機格式不正確"}return null},Ie=({detail:s,reload:a,showAlert:l})=>{var v,c,x;const t=n.useMemo(()=>{var f,k,r;return{name:((f=s.profile)==null?void 0:f.name)??"",email:((k=s.profile)==null?void 0:k.email)??"",phone:((r=s.profile)==null?void 0:r.phone)??""}},[s]),[i,o]=n.useState(!1),[d,j]=n.useState(!1),[m,u]=n.useState(t),p=n.useMemo(()=>T(m.name)!==T(t.name)||T(m.email)!==T(t.email)||T(m.phone)!==T(t.phone),[m,t]),y=n.useMemo(()=>ee(m),[m]);n.useEffect(()=>{i||u(t)},[t,i]);const N=()=>{u(t),o(!0)},b=()=>{u(t),o(!1)},w=async()=>{const f=ee(m);if(f){l==null||l(f,"warning");return}if(!p){o(!1);return}j(!0);try{await ge(s.id,{name:T(m.name),email:T(m.email)||null,phone:T(m.phone)||null}),l==null||l("更新成功","success"),o(!1),await a()}catch(k){console.error(k),l==null||l("更新失敗，請稍後再試","danger")}finally{j(!1)}};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header align-items-center",children:[e.jsx("div",{className:"card-title m-0",children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(g,{iconName:"information-4",className:"fs-2"}),e.jsx("h3",{className:"fw-bold m-0",children:"基本資訊"})]})}),e.jsxs("div",{className:"card-toolbar d-flex align-items-center gap-2",children:[s.enabled?e.jsx("span",{className:"badge badge-light-success",children:"啟用"}):e.jsx("span",{className:"badge badge-light-secondary",children:"停用"}),s.locked?e.jsx("span",{className:"badge badge-light-danger",children:"已鎖定"}):e.jsx("span",{className:"badge badge-light-success",children:"未鎖定"}),i?e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-sm btn-primary",onClick:w,disabled:d||!!y||!p,title:p?y??"":"尚未修改",children:d?e.jsxs("span",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"spinner-border spinner-border-sm"}),"更新中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{iconName:"check",className:"fs-3 me-1"}),"更新"]})}),e.jsx("button",{type:"button",className:"btn btn-sm btn-light",onClick:b,disabled:d,children:"取消"})]}):e.jsxs("button",{type:"button",className:"btn btn-sm btn-light-primary",onClick:N,children:[e.jsx(g,{iconName:"pencil",className:"fs-3 me-1"}),"編輯"]})]})]}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-row-dashed table-row-gray-200 align-middle gs-0 gy-3",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"帳號"}),e.jsxs("td",{className:"fw-semibold",children:[e.jsx("span",{className:"badge badge-light text-gray-800",children:$(s.username)}),e.jsx("span",{className:"text-muted fs-8 ms-3",children:"（建立後不可修改）"})]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"姓名"}),e.jsx("td",{className:"fw-semibold",children:i?e.jsx("input",{className:"form-control form-control-sm",value:m.name,onChange:f=>u(k=>({...k,name:f.target.value})),placeholder:"例如：王小明",disabled:d,maxLength:128}):$(((v=s.profile)==null?void 0:v.name)??null)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"Email"}),e.jsx("td",{className:"fw-semibold",children:i?e.jsx("input",{className:"form-control form-control-sm",value:m.email,onChange:f=>u(k=>({...k,email:f.target.value})),placeholder:"例如：user@example.com",disabled:d,maxLength:128,inputMode:"email"}):$(((c=s.profile)==null?void 0:c.email)??null)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"手機"}),e.jsx("td",{className:"fw-semibold",children:i?e.jsx("input",{className:"form-control form-control-sm",value:m.phone,onChange:f=>u(k=>({...k,phone:f.target.value})),placeholder:"例如：0912-345-678",disabled:d,maxLength:32,inputMode:"tel"}):$(((x=s.profile)==null?void 0:x.phone)??null)})]})]})})}),e.jsx("div",{className:"d-flex justify-content-between align-items-center mt-3",children:e.jsxs("div",{className:"text-muted fs-8",children:["UUID：",$(s.id)]})}),i&&e.jsx("div",{className:"text-muted fs-8 mt-3",children:"提示：Email/手機可留空；若要清空請刪除內容後更新。"})]})]})},$e=s=>s==null||s===""?"-":String(s),Fe=({detail:s,reload:a,showAlert:l})=>{const[t,i]=n.useState(!1),o=n.useMemo(()=>!s.enabled,[s.enabled]),d=n.useMemo(()=>!s.locked,[s.locked]),j=(u,p)=>u==="enabled"?p?`確認要「啟用」此帳號？

啟用後：使用者可登入（仍受 locked/權限影響）。`:`確認要「停用」此帳號？

停用後：使用者將無法登入（建議用於離職/停權）。`:p?`確認要「鎖定」此帳號？

鎖定後：使用者即使 enabled 仍無法登入。`:`確認要「解除鎖定」此帳號？

解除後：若 enabled=true，使用者即可登入。`,m=async u=>{if(t)return;const p=u==="enabled"?o:d;if(window.confirm(j(u,p))){i(!0);try{const N=u==="enabled"?{enabled:p}:{locked:p};if(!await ve(s.id,N,l))return;l==null||l("更新成功","success"),await a()}finally{i(!1)}}};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header align-items-center",children:[e.jsx("div",{className:"card-title m-0",children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(g,{iconName:"shield-tick",className:"fs-2"}),e.jsx("h3",{className:"fw-bold m-0",children:"狀態與安全"})]})}),e.jsx("div",{className:"card-toolbar",children:t&&e.jsxs("span",{className:"text-muted fs-8 d-flex align-items-center gap-2",children:[e.jsx("span",{className:"spinner-border spinner-border-sm"}),"更新中..."]})})]}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-row-dashed table-row-gray-200 align-middle gs-0 gy-3",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted w-150px",children:"帳號狀態"}),e.jsx("td",{className:"fw-semibold",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[s.enabled?e.jsx("span",{className:"badge badge-light-success",children:"啟用"}):e.jsx("span",{className:"badge badge-light-secondary",children:"停用"}),e.jsx("span",{className:"text-muted fs-8 ms-3",children:s.enabled?"可登入（仍受鎖定影響）":"不可登入"})]}),e.jsxs("button",{type:"button",className:`btn btn-sm ${s.enabled?"btn-light-secondary":"btn-light-success"}`,disabled:t,onClick:()=>m("enabled"),children:[e.jsx(g,{iconName:s.enabled?"cross-circle":"check-circle",className:"fs-3 me-1"}),s.enabled?"停用":"啟用"]})]})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"鎖定狀態"}),e.jsx("td",{className:"fw-semibold",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[s.locked?e.jsx("span",{className:"badge badge-light-danger",children:"已鎖定"}):e.jsx("span",{className:"badge badge-light-success",children:"未鎖定"}),e.jsx("span",{className:"text-muted fs-8 ms-3",children:s.locked?"強制禁止登入（高風險/安全用途）":"正常"})]}),e.jsxs("button",{type:"button",className:`btn btn-sm ${s.locked?"btn-light-success":"btn-light-danger"}`,disabled:t,onClick:()=>m("locked"),children:[e.jsx(g,{iconName:s.locked?"unlock":"lock",className:"fs-3 me-1"}),s.locked?"解除鎖定":"鎖定"]})]})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"備註"}),e.jsx("td",{className:"fw-semibold text-muted fs-8",children:"建議：enabled 用於停權/離職；locked 用於安全事件（風險操作），避免混用。"})]})]})})}),e.jsxs("div",{className:"text-muted fs-8 mt-3",children:["UUID：",$e(s.id)]})]})]})},He=({detail:s})=>{var a,l;return e.jsxs("div",{className:"card mb-5",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"card-title",children:"角色與權限"})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h5",{children:"角色"}),((a=s.roles)==null?void 0:a.length)>0?e.jsx("ul",{children:s.roles.map(t=>e.jsx("li",{children:e.jsx("span",{className:"badge badge-light-primary",children:t.name})},t.code))}):e.jsx("span",{className:"text-muted",children:"尚未指派角色"})]}),e.jsxs("div",{children:[e.jsx("h5",{children:"權限列表"}),((l=s.permissions)==null?void 0:l.length)>0?e.jsx("div",{className:"d-flex flex-wrap gap-2",children:s.permissions.map(t=>e.jsx("span",{className:"badge badge-light-info",children:t},t))}):e.jsx("span",{className:"text-muted",children:"尚無權限"})]})]})]})},We=({detail:s,showAlert:a})=>{var c;const[l,t]=n.useState(!1),[i,o]=n.useState(null),[d,j]=n.useState(""),[m,u]=n.useState(""),p=n.useMemo(()=>{const x=(i??s.permissions??[]).filter(Boolean);return Array.from(new Set(x)).sort((f,k)=>f.localeCompare(k))},[s.permissions,i]),y=n.useMemo(()=>{const x=m.trim().toLowerCase();return x?p.filter(f=>f.toLowerCase().includes(x)):p},[p,m]),N=()=>u(d.trim()),b=()=>{j(""),u("")},w=async()=>{t(!0);try{const x=await ye(s.id,a);x&&x.length>0?o(x):o([])}finally{t(!1)}},v=async()=>{try{await navigator.clipboard.writeText(y.join(`
`)),a==null||a("已複製權限清單","success")}catch(x){console.error(x),a==null||a("複製失敗（瀏覽器權限限制）","warning")}};return n.useEffect(()=>{o(null),j(""),u("")},[s.id]),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header align-items-center",children:[e.jsx("div",{className:"card-title m-0",children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(g,{iconName:"key",className:"fs-2"}),e.jsx("h3",{className:"fw-bold m-0",children:"權限摘要"})]})}),e.jsx("div",{className:"card-toolbar",children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-light",onClick:v,disabled:y.length===0,children:[e.jsx(g,{iconName:"copy",className:"fs-3 me-1"}),"複製"]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-light-primary",onClick:w,disabled:l,children:l?e.jsxs("span",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"spinner-border spinner-border-sm"}),"刷新中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{iconName:"arrows-circle",className:"fs-3 me-1"}),"刷新"]})})]})})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-wrap gap-3 mb-4",children:[e.jsxs("div",{className:"text-muted fs-8",children:["Roles：",e.jsx("span",{className:"fw-bold",children:((c=s.roles)==null?void 0:c.length)??0})]}),e.jsxs("div",{className:"text-muted fs-8",children:["Permissions：",e.jsx("span",{className:"fw-bold",children:p.length})]}),i!==null&&e.jsx("span",{className:"badge badge-light-info",children:"已從 Server 刷新"})]}),e.jsxs("div",{className:"d-flex align-items-center gap-2 flex-wrap mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center position-relative flex-grow-1",style:{minWidth:220},children:[e.jsx(g,{iconName:"magnifier",className:"fs-1 position-absolute ms-6"}),e.jsx("input",{type:"text",className:"form-control form-control-solid ps-14",placeholder:"搜尋權限，例如：upms.user",value:d,onChange:x=>j(x.target.value),onKeyDown:x=>{x.key==="Enter"&&N()}})]}),e.jsx("button",{type:"button",className:"btn btn-light-primary",onClick:N,children:"搜尋"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:b,children:"重置"})]}),y.length===0?e.jsxs("div",{className:"text-center py-8 text-muted",children:[p.length===0?"目前沒有任何權限":"查無符合的權限",e.jsx("div",{className:"fs-8 mt-2",children:"可點右上角「刷新」取得最新計算結果"})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-200 align-middle gs-0 gy-3",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-muted fw-semibold fs-8",children:[e.jsx("th",{style:{width:70},children:"#"}),e.jsx("th",{children:"Permission"})]})}),e.jsx("tbody",{children:y.map((x,f)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:f+1}),e.jsx("td",{className:"fw-semibold",children:e.jsx("code",{className:"text-gray-800",children:x})})]},x))})]})}),e.jsx("div",{className:"text-muted fs-8 mt-3",children:"提示：此處顯示「有效權限」(effective permissions)。若你後端尚未做計算，會先用 detail.permissions。"})]})]})},Ve=()=>{const{id:s}=se(),{alert:a,showAlert:l,Alert:t}=H(),[i,o]=n.useState(!0),[d,j]=n.useState(null),m=n.useCallback(async()=>{if(s){o(!0);try{const u=await ne(s);j(u)}catch(u){console.error(u),l("取得使用者詳情失敗","danger"),j(null)}finally{o(!1)}}},[s,l]);return n.useEffect(()=>{m()},[m]),e.jsxs(_,{children:[a&&e.jsx(t,{message:a.message,type:a.type}),e.jsx(O,{title:"使用者詳情",breadcrumbs:[{label:"權限管理",href:"#"},{label:"使用者",active:!1},{label:"詳情",active:!0}]}),e.jsx("div",{className:"app-container container-fluid",children:i?e.jsx("div",{className:"d-flex justify-content-center py-10",children:e.jsx(ae,{animation:"border"})}):d?e.jsxs("div",{className:"row g-6",children:[e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(Ie,{detail:d,reload:m,showAlert:l})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(Fe,{detail:d,reload:m,showAlert:l})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(He,{detail:d,reload:m,showAlert:l})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(We,{detail:d,showAlert:l})})]}):e.jsx("div",{className:"text-center py-10 text-muted",children:"查無使用者資料"})})]})},ze=({userId:s,username:a,onPasswordReset:l,showAlert:t})=>{const[i,o]=n.useState(""),[d,j]=n.useState(""),[m,u]=n.useState(!1),[p,y]=n.useState(!1),N=async()=>{if(!i){t==null||t("請輸入新密碼","warning");return}if(i.length<8){t==null||t("密碼長度至少需要 8 個字元","warning");return}if(i!==d){t==null||t("兩次輸入的密碼不一致","warning");return}u(!0);try{await l(i)&&(o(""),j(""))}finally{u(!1)}},b=()=>{const w="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let v="";for(let c=0;c<12;c++)v+=w.charAt(Math.floor(Math.random()*w.length));o(v),j(v)};return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header border-0 pt-6",children:e.jsxs("h3",{className:"card-title align-items-start flex-column",children:[e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"密碼管理"}),e.jsx("span",{className:"text-muted mt-1 fw-semibold fs-7",children:"重設使用者密碼"})]})}),e.jsxs("div",{className:"card-body pt-0",children:[e.jsxs("div",{className:"mb-5",children:[e.jsx("label",{className:"form-label fw-bold",children:"帳號"}),e.jsx("input",{type:"text",className:"form-control form-control-solid",value:a,disabled:!0})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("label",{className:"form-label fw-bold",children:["新密碼 ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:p?"text":"password",className:"form-control form-control-solid",placeholder:"請輸入新密碼（至少 8 個字元）",value:i,onChange:w=>o(w.target.value),disabled:m}),e.jsx("button",{type:"button",className:"btn btn-sm btn-icon btn-light position-absolute end-0 top-50 translate-middle-y me-2",onClick:()=>y(!p),children:e.jsx(g,{iconName:p?"eye-slash":"eye",className:"fs-2"})})]}),e.jsx("div",{className:"form-text",children:"密碼長度至少需要 8 個字元"})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("label",{className:"form-label fw-bold",children:["確認密碼 ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:p?"text":"password",className:"form-control form-control-solid",placeholder:"請再次輸入新密碼",value:d,onChange:w=>j(w.target.value),disabled:m})]}),e.jsxs("div",{className:"d-flex justify-content-end gap-3",children:[e.jsxs("button",{type:"button",className:"btn btn-light",onClick:b,disabled:m,children:[e.jsx(g,{iconName:"arrows-circle",className:"fs-2 me-2"}),"產生隨機密碼"]}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:N,disabled:m||!i||!d,children:m?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2"}),"重設中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{iconName:"check",className:"fs-2 me-2"}),"重設密碼"]})})]})]})]})},Be=s=>{if(!s)return"-";try{const a=new Date(s);if(Number.isNaN(a.getTime()))return s;const l=a.getFullYear(),t=String(a.getMonth()+1).padStart(2,"0"),i=String(a.getDate()).padStart(2,"0"),o=String(a.getHours()).padStart(2,"0"),d=String(a.getMinutes()).padStart(2,"0");return`${l}/${t}/${i} ${o}:${d}`}catch{return s}},Ke=({detail:s})=>{const a=s.loginHistory??[];return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header border-0 pt-6",children:e.jsxs("h3",{className:"card-title align-items-start flex-column",children:[e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"登入紀錄"}),e.jsx("span",{className:"text-muted mt-1 fw-semibold fs-7",children:"最近登入活動紀錄"})]})}),e.jsxs("div",{className:"card-body pt-0",children:[a.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx(g,{iconName:"lock",className:"fs-2x text-muted mb-3"}),e.jsx("p",{className:"text-muted mb-0",children:"尚無登入紀錄"})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"fw-bold text-muted",children:[e.jsx("th",{className:"min-w-150px",children:"登入時間"}),e.jsx("th",{className:"min-w-120px",children:"IP 位址"}),e.jsx("th",{className:"min-w-100px",children:"裝置"}),e.jsx("th",{className:"min-w-100px",children:"狀態"})]})}),e.jsx("tbody",{children:a.map((l,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("span",{className:"text-gray-800 fw-bold",children:Be(l.time)})}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-light-info fs-7 fw-bold",children:l.ip||"-"})}),e.jsx("td",{children:e.jsx("span",{className:"text-muted fs-7",children:l.device||"未知裝置"})}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-light-success fs-7",children:"成功"})})]},t))})]})}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"separator separator-dashed my-6"}),e.jsx("div",{className:"d-flex align-items-center",children:e.jsx("div",{className:"flex-grow-1",children:e.jsxs("span",{className:"text-muted fs-7",children:["顯示最近 ",e.jsx("strong",{children:a.length})," 筆登入紀錄"]})})})]})]})]})},qe=({userId:s,onForceLogoutAll:a,showAlert:l})=>e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header border-0 pt-6",children:e.jsxs("h3",{className:"card-title align-items-start flex-column",children:[e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"裝置管理"}),e.jsx("span",{className:"text-muted mt-1 fw-semibold fs-7",children:"管理使用者的登入裝置"})]})}),e.jsxs("div",{className:"card-body pt-0",children:[e.jsx("div",{className:"d-flex align-items-center mb-5",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h4",{className:"fw-bold mb-1",children:"強制登出所有裝置"}),e.jsx("p",{className:"text-muted fs-7 mb-0",children:"此操作將使該使用者的所有已登入裝置立即登出，使用者需要重新登入才能繼續使用系統。"})]})}),e.jsx("div",{className:"separator separator-dashed my-5"}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("button",{type:"button",className:"btn btn-light-danger",onClick:a,children:[e.jsx(g,{iconName:"logout",className:"fs-2 me-2"}),"強制登出所有裝置"]})})]})]}),Ge=({detail:s})=>{const a=s.loginHistory??[],l=a.length>0?a[0]:null;return e.jsxs("div",{className:"card mb-5",children:[e.jsx("div",{className:"card-header border-0 pt-6",children:e.jsxs("h3",{className:"card-title align-items-start flex-column",children:[e.jsx("span",{className:"card-label fw-bold fs-3 mb-1",children:"安全摘要"}),e.jsx("span",{className:"text-muted mt-1 fw-semibold fs-7",children:"使用者帳號安全狀態總覽"})]})}),e.jsxs("div",{className:"card-body pt-0",children:[e.jsx("table",{className:"table table-row-dashed table-row-gray-200 align-middle gs-0 gy-3",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted w-150px",children:"帳號狀態"}),e.jsxs("td",{children:[s.enabled?e.jsx("span",{className:"badge badge-light-success",children:"啟用"}):e.jsx("span",{className:"badge badge-light-secondary",children:"停用"}),s.locked&&e.jsx("span",{className:"badge badge-light-danger ms-2",children:"已鎖定"})]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"帳號名稱"}),e.jsx("td",{className:"fw-semibold",children:s.username})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"最後登入"}),e.jsx("td",{children:l?e.jsxs("div",{children:[e.jsx("div",{className:"fw-semibold",children:l.time}),e.jsxs("div",{className:"text-muted fs-7",children:["IP: ",l.ip]})]}):e.jsx("span",{className:"text-muted",children:"無登入紀錄"})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"登入次數"}),e.jsx("td",{children:e.jsxs("span",{className:"badge badge-light-primary fs-6 fw-bold",children:[a.length," 次"]})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"兩步驟驗證"}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-light-secondary",children:"未啟用"})})]})]})}),e.jsx("div",{className:"separator separator-dashed my-6"}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"flex-grow-1",children:e.jsxs("span",{className:"text-muted fs-7",children:["安全等級：",e.jsx("strong",{className:"text-primary",children:"中等"})]})}),e.jsxs("button",{type:"button",className:"btn btn-sm btn-light",onClick:()=>window.location.href=`/upms/user/${s.id}/detail`,children:["查看詳情",e.jsx(g,{iconName:"arrow-right",className:"fs-4 ms-1"})]})]})]})]})},Ye=()=>{var y;const{id:s}=se();W();const{alert:a,showAlert:l,Alert:t}=H(),[i,o]=n.useState(!0),[d,j]=n.useState(null),m=n.useCallback(async()=>{if(s){o(!0);try{const N=await ne(s);j(N)}catch(N){console.error(N),l("取得使用者資訊失敗","danger"),j(null)}finally{o(!1)}}},[s,l]);n.useEffect(()=>{m()},[m]);const u=async N=>{if(!s)return!1;try{return await Ne(s,N,l)?(l("密碼已成功重設","success"),!0):!1}catch(b){return console.error(b),l("重設密碼失敗","danger"),!1}},p=async()=>{if(!(!s||!window.confirm(`確定要強制登出此使用者的所有裝置嗎？

使用者需要重新登入才能繼續使用系統。`)))try{l("功能開發中，請稍後再試","warning")}catch(b){console.error(b),l("強制登出失敗","danger")}};return i?e.jsxs(_,{children:[e.jsx(O,{title:"使用者安全設定",breadcrumbs:[{label:"權限管理",href:"#",active:!1},{label:"使用者",active:!1},{label:"安全設定",active:!0}]}),e.jsx("div",{className:"d-flex justify-content-center py-10",children:e.jsx(ae,{animation:"border"})})]}):d?e.jsxs(_,{children:[a&&e.jsx(t,{message:a.message,type:a.type}),e.jsx(O,{title:"使用者安全設定",breadcrumbs:[{label:"權限管理",href:"#",active:!1},{label:"使用者",active:!1},{label:((y=d.profile)==null?void 0:y.name)||d.username,href:`/upms/user/${s}/detail`,active:!1},{label:"安全設定",active:!0}]}),e.jsx("div",{className:"app-container container-fluid",children:e.jsxs("div",{className:"row g-6",children:[e.jsx("div",{className:"col-12 col-lg-4",children:e.jsx(Ge,{detail:d})}),e.jsxs("div",{className:"col-12 col-lg-8",children:[e.jsx("div",{className:"mb-6",children:e.jsx(ze,{userId:s,username:d.username,onPasswordReset:u,showAlert:l})}),e.jsx("div",{className:"mb-6",children:e.jsx(qe,{userId:s,onForceLogoutAll:p,showAlert:l})}),e.jsx("div",{className:"mb-6",children:e.jsx(Ke,{detail:d})})]})]})})]}):e.jsxs(_,{children:[e.jsx(O,{title:"使用者安全設定",breadcrumbs:[{label:"權限管理",href:"#",active:!1},{label:"使用者",active:!1},{label:"安全設定",active:!0}]}),e.jsx("div",{className:"text-center py-10 text-muted",children:"查無使用者資料"})]})},F=[{title:"使用者管理",path:"/upms/user/overview",isSeparator:!1,isActive:!1},{title:"",path:"",isSeparator:!0,isActive:!1}],ua=()=>e.jsxs(de,{children:[e.jsx(I,{path:"overview",element:e.jsxs(e.Fragment,{children:[e.jsx(L,{breadcrumbs:F,children:"使用者總覽"}),e.jsx(we,{})]})}),e.jsx(I,{path:"list",element:e.jsxs(e.Fragment,{children:[e.jsx(L,{breadcrumbs:F,children:"使用者列表"}),e.jsx(Pe,{})]})}),e.jsx(I,{path:"create",element:e.jsxs(e.Fragment,{children:[e.jsx(L,{breadcrumbs:F,children:"新增使用者"}),e.jsx(_e,{})]})}),e.jsx(I,{path:":id/detail",element:e.jsxs(e.Fragment,{children:[e.jsx(L,{breadcrumbs:F,children:"使用者詳情"}),e.jsx(Ve,{})]})}),e.jsx(I,{path:":id/security",element:e.jsxs(e.Fragment,{children:[e.jsx(L,{breadcrumbs:F,children:"使用者安全設定"}),e.jsx(Ye,{})]})})]});export{ua as default};

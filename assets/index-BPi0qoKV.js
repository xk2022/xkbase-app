import{r as n,j as e}from"./react-DwkAs-v9.js";import{i as k,h as O,e as A,C as F,K as C,P as h}from"./index-CbhZY4ci.js";import{A as V}from"./AppToolbar-BZHSVYI7.js";import{u as w}from"./formik-B67XZPDW.js";import{a as y,d as K,e as x,f as H}from"./react-router-Df4HDh8c.js";import{C as Y}from"./ConfirmDeleteModal-B-C_keKM.js";import{P as z}from"./PagedTable-fW2f3xMh.js";import"./apexcharts-sziEC8OT.js";import"./react-dom-DVTd-Q6a.js";import"./scheduler-CylivXx-.js";import"./axios-mH-cpkvd.js";import"./yup-BLKqc-jj.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-7gDswQQa.js";import"./clsx-B-dksMZM.js";import"./react-router-dom-BJfVfmV5.js";import"./@remix-run-DUdlTjFu.js";import"./chart.js-xWmoy_ii.js";import"./@kurkle-D8fDXNIl.js";import"./@tanstack-BGZqBxWN.js";import"./react-copy-to-clipboard-C4AWj7CK.js";import"./copy-to-clipboard-BvYTofsP.js";import"./toggle-selection-BHUZwh74.js";import"./prism-react-renderer-BV8xJdsO.js";import"./react-bootstrap-BUaeuJHt.js";import"./classnames-Bztn78Bv.js";import"./dom-helpers-C9Bu-4wA.js";import"./@restart-rvtB3BAN.js";import"./dequal-tFQomdd2.js";import"./@popperjs-D8Kg5PqX.js";import"./warning-DaFg7xBm.js";import"./prop-types-smO-eibg.js";import"./uncontrollable-C0VNg-tm.js";import"./react-transition-group-DSbRRiC3.js";import"./@babel-B036hIWL.js";import"./react-select-Z1ywkuii.js";import"./@emotion-Cdt29Dgm.js";import"./hoist-non-react-statics-C-8QU_9G.js";import"./react-is-8JwjhRSi.js";import"./stylis-YPZU7XtI.js";import"./@floating-ui-DZ2V_EUC.js";import"./use-isomorphic-layout-effect-CgCMJW-V.js";import"./memoize-one-DxrTgWdQ.js";import"./react-topbar-progress-indicator-BI-R5WY2.js";import"./topbar-C3UDlew2.js";import"./bootstrap-D7dJWYZj.js";import"./deepmerge-DhIoniG1.js";import"./lodash-es-ClCkCI8n.js";import"./react-fast-compare-0sFLRPh9.js";const S=[{id:"t-001",taskNo:"TASK-2026-0001",subjectType:"CONTAINER",subjectId:"c-001",subjectNo:"OOLU1234567",orderId:"o-001",orderNo:"TOM-2026-0001",containerId:"c-001",containerNo:"OOLU1234567",fromLocation:"桃園南崁倉",toLocation:"基隆港",plannedStartAt:"2026-01-05T08:30:00+08:00",status:"UNASSIGNED",remark:"待指派",createdTime:"2026-01-03T09:20:00+08:00"},{id:"t-002",taskNo:"TASK-2026-0002",subjectType:"CONTAINER",subjectId:"c-002",subjectNo:"OOLU1234568",orderId:"o-001",orderNo:"TOM-2026-0001",containerId:"c-002",containerNo:"OOLU1234568",fromLocation:"桃園南崁倉",toLocation:"基隆港",plannedStartAt:"2026-01-05T10:00:00+08:00",status:"ASSIGNED",driverName:"陳大偉",vehicleNo:"KAA-7788",trailerNo:"TR-102",createdTime:"2026-01-03T09:25:00+08:00"},{id:"t-003",taskNo:"TASK-2026-0003",subjectType:"TRAILER",subjectId:"tr-102",subjectNo:"TR-102",fromLocation:"基隆港堆場",toLocation:"桃園南崁倉",plannedStartAt:"2026-01-05T13:30:00+08:00",status:"UNASSIGNED",remark:"拉空板車回倉（指定板車）",createdTime:"2026-01-03T11:10:00+08:00"},{id:"t-004",taskNo:"TASK-2026-0004",subjectType:"EMPTY_MOVE",fromLocation:"台中港",toLocation:"新竹物流園區",plannedStartAt:"2026-01-06T15:00:00+08:00",status:"IN_PROGRESS",driverName:"林雅婷",vehicleNo:"KBC-2233",remark:"空車回位（不指定板車/貨櫃）",createdTime:"2026-01-04T11:10:00+08:00"},{id:"t-005",taskNo:"TASK-2026-0005",subjectType:"VEHICLE",subjectId:"vh-001",subjectNo:"KDD-5566",fromLocation:"桃園蘆竹停車場",toLocation:"基隆港堆場",plannedStartAt:"2026-01-07T09:00:00+08:00",status:"DONE",driverName:"王志豪",vehicleNo:"KDD-5566",remark:"調車：車頭移動到港口待命",createdTime:"2026-01-05T08:10:00+08:00"}],B=(t,a)=>[t.taskNo,t.subjectType,t.subjectNo??"",t.orderNo??"",t.containerNo??"",t.fromLocation,t.toLocation,t.driverName??"",t.vehicleNo??"",t.trailerNo??"",t.remark??""].join(" ").toLowerCase().includes(a.toLowerCase());async function J(t,a){var r,l,i;if(k()){console.log("[Mock] 使用 Mock 任務列表",t),await new Promise(j=>setTimeout(j,300));const c=t.page??0,u=t.size??10,b=((r=t.keyword)==null?void 0:r.trim())??"",p=((l=t.subjectType)==null?void 0:l.trim())??"",d=((i=t.status)==null?void 0:i.trim())??"";let N=[...S];b&&(N=N.filter(j=>B(j,b))),p&&(N=N.filter(j=>j.subjectType===p)),d&&(N=N.filter(j=>j.status===d));const m=N.length,s=Math.max(1,Math.ceil(m/u)),f=c*u,g=N.slice(f,f+u);return{content:g,totalElements:m,totalPages:s,size:u,number:c,first:c===0,last:c>=s-1,empty:g.length===0}}try{return(await O.get("/api/tom/tasks",{params:t})).data.data}catch(c){return console.error(c),a==null||a("取得任務列表失敗，請稍後再試","danger"),{content:[],totalElements:0,totalPages:1,size:t.size??10,number:t.page??0,first:!0,last:!0,empty:!0}}}async function W(t,a){if(k()){console.log("[Mock] 模擬建立任務",t),await new Promise(c=>setTimeout(c,500));const r=`t-${String(Math.floor(Math.random()*9e5)+1e5)}`,l=`TASK-2026-${String(Math.floor(Math.random()*9999)).padStart(4,"0")}`,i={id:r,taskNo:l,subjectType:t.subjectType,subjectId:t.subjectId,subjectNo:t.subjectNo,orderId:t.orderId,orderNo:t.orderNo,containerId:t.containerId,containerNo:t.containerNo,fromLocation:t.fromLocation,toLocation:t.toLocation,plannedStartAt:t.plannedStartAt,status:t.status??"UNASSIGNED",remark:t.remark,createdTime:new Date().toISOString()};return S.unshift(i),a==null||a("任務建立成功 (Mock)","success"),i}try{const r=await O.post("/api/tom/tasks",t);return a==null||a("任務建立成功","success"),r.data.data}catch(r){throw console.error(r),a==null||a("建立任務失敗，請稍後再試","danger"),r}}async function Z(t,a){if(k()){console.log("[Mock] 模擬取消任務",t),await new Promise(l=>setTimeout(l,500));const r=S.findIndex(l=>l.id===t);return r>=0&&(S[r]={...S[r],status:"CANCELLED"}),a==null||a("任務取消成功 (Mock)","success"),!0}try{return await O.post(`/api/tom/tasks/${t}/cancel`),a==null||a("任務取消成功","success"),!0}catch(r){return console.error(r),a==null||a("取消任務失敗，請稍後再試","danger"),!1}}const Q=[{value:"CONTAINER",label:"貨櫃（CONTAINER）"},{value:"TRAILER",label:"板車（TRAILER）"},{value:"EMPTY_MOVE",label:"空車/空板回位（EMPTY_MOVE）"},{value:"VEHICLE",label:"車頭（VEHICLE）"},{value:"OTHER",label:"其他（OTHER）"}],X=[{value:"UNASSIGNED",label:"未指派"},{value:"ASSIGNED",label:"已指派"},{value:"IN_PROGRESS",label:"進行中"},{value:"DONE",label:"已完成"},{value:"CANCELLED",label:"已取消"}],q=({submitting:t,onSubmit:a,onCancel:r})=>{const l=w({initialValues:{subjectType:"CONTAINER",subjectId:"",subjectNo:"",orderId:"",orderNo:"",containerId:"",containerNo:"",fromLocation:"",toLocation:"",plannedStartAt:"",status:"UNASSIGNED",remark:""},onSubmit:a}),i=l.values.subjectType,c=i==="CONTAINER",u=i==="TRAILER",b=i==="VEHICLE",p=n.useMemo(()=>{switch(i){case"CONTAINER":return"MVP：可先手動輸入 containerNo（之後接貨櫃選擇器）";case"TRAILER":return"可指定板車編號（例如 TR-102），或留空表示「拉任一空板」改用 EMPTY_MOVE 更語意化";case"EMPTY_MOVE":return"空車/空板回位：通常不需要輸入標的編號";case"VEHICLE":return"可輸入車頭/車牌（例如 KDD-5566）";default:return"其他類型：可在備註描述標的"}},[i]),d=m=>{const s=(m??"").trim();return s||void 0},N=async m=>{if(m.preventDefault(),!l.values.fromLocation.trim()||!l.values.toLocation.trim())return;const s=l.values;await a({subjectType:s.subjectType,subjectId:d(s.subjectId),subjectNo:d(s.subjectNo),orderId:d(s.orderId),orderNo:d(s.orderNo),containerId:c?d(s.containerId):void 0,containerNo:c?d(s.containerNo):void 0,fromLocation:s.fromLocation.trim(),toLocation:s.toLocation.trim(),plannedStartAt:d(s.plannedStartAt),status:s.status,remark:d(s.remark)})};return e.jsxs("form",{onSubmit:N,children:[e.jsxs("div",{className:"row g-5",children:[e.jsxs("div",{className:"col-12 col-md-4",children:[e.jsx("label",{className:"form-label",children:"任務類型"}),e.jsx("select",{className:"form-select",...l.getFieldProps("subjectType"),disabled:t,children:Q.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),e.jsxs("div",{className:"col-12 col-md-4",children:[e.jsx("label",{className:"form-label",children:"狀態"}),e.jsx("select",{className:"form-select",...l.getFieldProps("status"),disabled:t,children:X.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),e.jsxs("div",{className:"col-12 col-md-4",children:[e.jsx("label",{className:"form-label",children:"預計時間（可選）"}),e.jsx("input",{type:"datetime-local",className:"form-control",...l.getFieldProps("plannedStartAt"),disabled:t})]}),(c||u||b)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",children:c?"貨櫃編號":u?"板車編號":"車牌/車頭編號"}),e.jsx("input",{type:"text",className:"form-control",placeholder:c?"例如：OOLU1234567":u?"例如：TR-102":"例如：KDD-5566",...l.getFieldProps("subjectNo"),disabled:t}),e.jsx("div",{className:"form-text",children:p})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",children:"標的 ID（可選）"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"MVP 可留空（之後接 FMS/資產選擇器）",...l.getFieldProps("subjectId"),disabled:t})]})]}),i==="EMPTY_MOVE"&&e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-info mb-0",children:p})}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",children:"訂單編號（可選）"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"例如：TOM-2026-0001",...l.getFieldProps("orderNo"),disabled:t}),e.jsx("div",{className:"form-text",children:"若此任務源自訂單，可填入做關聯（MVP：先手動）。"})]}),c&&e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",children:"貨櫃編號（關聯）（可選）"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"例如：OOLU1234567",...l.getFieldProps("containerNo"),disabled:t}),e.jsx("div",{className:"form-text",children:"若此任務是貨櫃任務，這裡也可填（之後可由選擇器自動帶入）。"})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",children:"起點"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"例如：基隆港堆場",...l.getFieldProps("fromLocation"),required:!0,disabled:t})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{className:"form-label",children:"終點"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"例如：桃園南崁倉",...l.getFieldProps("toLocation"),required:!0,disabled:t})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label",children:"備註（可選）"}),e.jsx("textarea",{className:"form-control",rows:3,placeholder:"例如：冷鏈/危品/需吊掛/拉空板回倉...",...l.getFieldProps("remark"),disabled:t})]})]}),e.jsxs("div",{className:"d-flex justify-content-end gap-3 mt-8",children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:r,disabled:t,children:"取消"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,children:t?"建立中…":"建立任務"})]})]})},ee=()=>{const t=y(),{alert:a,showAlert:r,Alert:l}=A(),[i,c]=n.useState(!1),u=n.useCallback(()=>{t(-1)},[t]),b=n.useCallback(async p=>{c(!0);try{const d=await W(p,r);r("建立任務成功","success"),t("/tom/task/list")}catch(d){console.error(d),r("建立任務失敗，請稍後再試","danger")}finally{c(!1)}},[t,r]);return e.jsxs(F,{children:[a&&e.jsx(l,{message:a.message,type:a.type}),e.jsx(V,{title:"新增任務（TOM）",breadcrumbs:[{label:"TOM 運輸管理",href:"/tom"},{label:"任務管理",href:"/tom/task/list"},{label:"新增",active:!0}]}),e.jsx("div",{className:"app-container container-fluid",children:e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx(q,{submitting:i,onSubmit:b,onCancel:u})})})})]})},te=10,ae=t=>{if(!t)return"-";const a=new Date(t);return Number.isNaN(a.getTime())?t:a.toLocaleString("zh-TW")},se=t=>{switch(t){case"UNASSIGNED":return"未指派";case"ASSIGNED":return"已指派";case"IN_PROGRESS":return"進行中";case"DONE":return"已完成";case"CANCELLED":return"已取消";default:return t??"-"}},re=t=>{switch(t.subjectType){case"CONTAINER":return`貨櫃｜${t.subjectNo??t.containerNo??"-"}`;case"TRAILER":return`板車｜${t.subjectNo??t.trailerNo??"-"}`;case"EMPTY_MOVE":return"空車/空板回位";case"VEHICLE":return`車頭｜${t.subjectNo??t.vehicleNo??"-"}`;default:return t.subjectNo??"其他"}},le=(t,a)=>{const r=t==null?void 0:t.trim(),l=a==null?void 0:a.trim();return!r&&!l?"-":r&&!l?`${r} -> -`:!r&&l?`- -> ${l}`:`${r} -> ${l}`},oe=({searchKeyword:t,subjectType:a,status:r,showAlert:l,onAssign:i})=>{const c=y(),[u,b]=n.useState([]),[p,d]=n.useState(0),[N,m]=n.useState(1),[s,f]=n.useState(1),[g,j]=n.useState(!1),[v,I]=n.useState(null),[P,M]=n.useState(!1),R=n.useMemo(()=>({page:s-1,size:te,keyword:t!=null&&t.trim()?t.trim():void 0,subjectType:a||void 0,status:r||void 0}),[s,t,a,r]),L=n.useCallback(async()=>{j(!0);try{const o=await J(R,l);b(o.content||[]),d(o.totalElements||0),m(o.totalPages||1)}finally{j(!1)}},[R,l]);n.useEffect(()=>f(1),[t,a,r]),n.useEffect(()=>{L()},[L]);const D=n.useCallback(o=>{o.containerId?c(`/tom/container/${o.containerId}/detail`):c("/tom/task/list")},[c]),U=o=>I(o),_=async()=>{if(v)try{M(!0),await Z(v.id,l)&&(await L(),I(null))}finally{M(!1)}},G=[{header:"任務編號",className:"min-w-160px"},{header:"標的",className:"min-w-170px"},{header:"訂單",className:"min-w-150px"},{header:"起點 -> 終點",className:"min-w-260px"},{header:"預計時間",className:"min-w-180px"},{header:"指派",className:"min-w-200px"},{header:"狀態",className:"min-w-110px"},{header:"操作",className:"min-w-260px"}];return e.jsxs(e.Fragment,{children:[e.jsx(z,{columns:G,rows:u,loading:g,emptyText:"沒有任務資料",page:s,totalPages:N,totalElements:p,onPrev:()=>f(o=>Math.max(1,o-1)),onNext:()=>f(o=>Math.min(N||1,o+1)),renderRow:o=>{const $=[o.driverName,o.vehicleNo,o.trailerNo].filter(Boolean).join(" / ")||"-";return e.jsxs("tr",{className:"cursor-pointer table-row-hover",onClick:()=>D(o),children:[e.jsx("td",{className:"fw-bold text-gray-900",children:o.taskNo}),e.jsx("td",{children:re(o)}),e.jsx("td",{children:o.orderNo??"-"}),e.jsx("td",{children:le(o.fromLocation,o.toLocation)}),e.jsx("td",{children:ae(o.plannedStartAt)}),e.jsx("td",{children:$}),e.jsx("td",{children:se(o.status)}),e.jsxs("td",{children:[e.jsxs("button",{className:"btn btn-sm btn-success ms-2",onClick:E=>{E.stopPropagation(),D(o)},children:[e.jsx(C,{iconName:"eye",className:"fs-2"}),"查看"]}),i&&e.jsxs("button",{className:"btn btn-sm btn-light-primary ms-2",onClick:E=>{E.stopPropagation(),i(o)},children:[e.jsx(C,{iconName:"truck",className:"fs-2"}),"指派"]}),e.jsxs("button",{className:"btn btn-sm btn-danger ms-2",onClick:E=>{E.stopPropagation(),U(o)},children:[e.jsx(C,{iconName:"cross",className:"fs-2"}),"取消"]})]})]},o.id)}}),v&&e.jsx(Y,{open:!!v,title:"取消任務",deleting:P,message:e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["確定要取消任務 ",e.jsx("strong",{children:v.taskNo})," 嗎？"]}),e.jsx("p",{className:"text-muted mb-0",children:"MVP：取消後狀態改為 CANCELLED。"})]}),onClose:()=>P?null:I(null),onConfirm:_})]})},ce=[{value:"",label:"全部類型"},{value:"CONTAINER",label:"貨櫃"},{value:"TRAILER",label:"板車"},{value:"EMPTY_MOVE",label:"空車/空板回位"},{value:"VEHICLE",label:"車頭"},{value:"OTHER",label:"其他"}],ne=[{value:"",label:"全部狀態"},{value:"UNASSIGNED",label:"未指派"},{value:"ASSIGNED",label:"已指派"},{value:"IN_PROGRESS",label:"進行中"},{value:"DONE",label:"已完成"},{value:"CANCELLED",label:"已取消"}],ie=()=>{const t=y(),{alert:a,showAlert:r,Alert:l}=A(),[i,c]=n.useState(""),[u,b]=n.useState(""),[p,d]=n.useState(""),N=n.useCallback(()=>{t("/tom/task/create")},[t]),m=n.useCallback(s=>{s.containerId?t(`/tom/container/${s.containerId}/detail`):r("此任務尚未接 FMS 指派（MVP）","info")},[t,r]);return e.jsxs(F,{children:[a&&e.jsx(l,{message:a.message,type:a.type}),e.jsx(V,{title:"任務管理（TOM）",breadcrumbs:[{label:"TOM 運輸管理",href:"/tom"},{label:"任務管理",active:!0}]}),e.jsxs("div",{className:"app-container container-fluid",children:[e.jsx("div",{className:"card mb-6",children:e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row g-3 align-items-end",children:[e.jsxs("div",{className:"col-12 col-md-4",children:[e.jsx("label",{className:"form-label",children:"關鍵字"}),e.jsx("input",{className:"form-control",value:i,onChange:s=>c(s.target.value),placeholder:"任務編號 / 訂單 / 櫃號 / 板車 / 地點 / 司機 / 車號..."})]}),e.jsxs("div",{className:"col-12 col-md-3",children:[e.jsx("label",{className:"form-label",children:"類型"}),e.jsx("select",{className:"form-select",value:u,onChange:s=>b(s.target.value),children:ce.map(s=>e.jsx("option",{value:s.value,children:s.label},s.label))})]}),e.jsxs("div",{className:"col-12 col-md-3",children:[e.jsx("label",{className:"form-label",children:"狀態"}),e.jsx("select",{className:"form-select",value:p,onChange:s=>d(s.target.value),children:ne.map(s=>e.jsx("option",{value:s.value,children:s.label},s.label))})]}),e.jsx("div",{className:"col-12 col-md-2 d-grid",children:e.jsx("button",{className:"btn btn-primary",onClick:N,children:"新增任務"})})]})})}),e.jsx(oe,{searchKeyword:i,subjectType:u,status:p,showAlert:r,onAssign:m})]})]})},T=[{title:"訂單管理",path:"/tom/order/overview",isSeparator:!1,isActive:!1},{title:"",path:"",isSeparator:!0,isActive:!1}],ot=()=>e.jsxs(K,{children:[e.jsx(x,{path:"",element:e.jsx(H,{to:"overview",replace:!0})}),e.jsx(x,{path:"overview",element:e.jsx(e.Fragment,{children:e.jsx(h,{breadcrumbs:T,children:"訂單總覽"})})}),e.jsx(x,{path:"list",element:e.jsxs(e.Fragment,{children:[e.jsx(h,{breadcrumbs:T,children:"訂單列表"}),e.jsx(ie,{})]})}),e.jsx(x,{path:"create",element:e.jsxs(e.Fragment,{children:[e.jsx(h,{breadcrumbs:T,children:"建立訂單"}),e.jsx(ee,{})]})}),e.jsx(x,{path:"assign",element:e.jsx(e.Fragment,{children:e.jsx(h,{breadcrumbs:T,children:"訂單指派"})})}),e.jsx(x,{path:":id/detail",element:e.jsx(e.Fragment,{children:e.jsx(h,{breadcrumbs:T,children:"訂單詳情"})})}),e.jsx(x,{path:"report",element:e.jsx(e.Fragment,{children:e.jsx(h,{breadcrumbs:T,children:"訂單報表"})})})]});export{ot as default};

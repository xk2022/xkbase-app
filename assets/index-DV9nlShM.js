import{j as e,r as n}from"./react-DwkAs-v9.js";import{i as U,h as $,e as F,C as G,K as f,o as te,P as O}from"./index-BdFDZIEO.js";import{u as ae}from"./formik-B67XZPDW.js";import{A as V}from"./AppToolbar-BZHSVYI7.js";import{t as H,a as W}from"./formUtils-DYBw-NTu.js";import{A as q,E as re,M as ne}from"./MockDataDialog-NPR1ODBB.js";import{a as _,g as Ne,d as je,e as M,f as be}from"./react-router-Df4HDh8c.js";import{C as ge}from"./ConfirmDeleteModal-BwZdlGN4.js";import{P as ie}from"./PagedTable-fW2f3xMh.js";import{S as z,M as A}from"./react-bootstrap-BUaeuJHt.js";import{f as fe}from"./Query-UyplWv-j.js";import{f as ve}from"./Query-BWlzpKDk.js";import"./apexcharts-sziEC8OT.js";import"./react-dom-DVTd-Q6a.js";import"./scheduler-CylivXx-.js";import"./axios-mH-cpkvd.js";import"./yup-BLKqc-jj.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-7gDswQQa.js";import"./clsx-B-dksMZM.js";import"./react-router-dom-BJfVfmV5.js";import"./@remix-run-DUdlTjFu.js";import"./chart.js-xWmoy_ii.js";import"./@kurkle-D8fDXNIl.js";import"./@tanstack-BGZqBxWN.js";import"./react-copy-to-clipboard-C4AWj7CK.js";import"./copy-to-clipboard-BvYTofsP.js";import"./toggle-selection-BHUZwh74.js";import"./prism-react-renderer-BV8xJdsO.js";import"./react-select-Z1ywkuii.js";import"./@babel-B036hIWL.js";import"./@emotion-Cdt29Dgm.js";import"./hoist-non-react-statics-C-8QU_9G.js";import"./react-is-8JwjhRSi.js";import"./stylis-YPZU7XtI.js";import"./@floating-ui-DZ2V_EUC.js";import"./use-isomorphic-layout-effect-CgCMJW-V.js";import"./memoize-one-DxrTgWdQ.js";import"./@popperjs-D8Kg5PqX.js";import"./react-topbar-progress-indicator-BI-R5WY2.js";import"./topbar-C3UDlew2.js";import"./bootstrap-D7dJWYZj.js";import"./deepmerge-DhIoniG1.js";import"./lodash-es-ClCkCI8n.js";import"./react-fast-compare-0sFLRPh9.js";import"./classnames-Bztn78Bv.js";import"./dom-helpers-C9Bu-4wA.js";import"./@restart-rvtB3BAN.js";import"./dequal-tFQomdd2.js";import"./warning-DaFg7xBm.js";import"./prop-types-smO-eibg.js";import"./uncontrollable-C0VNg-tm.js";import"./react-transition-group-DSbRRiC3.js";const ye=({submitting:s,onSubmit:t,onCancel:a})=>{const r=ae({initialValues:{orderType:"IMPORT",customerUuid:"",customerName:"",pickupAddress:"",deliveryAddress:"",scheduledAt:"",customerRefNo:"",note:""},onSubmit:t});return e.jsxs("form",{onSubmit:r.handleSubmit,children:[e.jsxs("div",{className:"row g-5",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"訂單類型"}),e.jsxs("select",{className:"form-select",...r.getFieldProps("orderType"),children:[e.jsx("option",{value:"IMPORT",children:"進口"}),e.jsx("option",{value:"EXPORT",children:"出口"}),e.jsx("option",{value:"LOCAL",children:"內陸"})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"客戶 UUID"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"請輸入客戶 UUID",...r.getFieldProps("customerUuid"),required:!0,disabled:s}),e.jsx("div",{className:"form-text",children:"MVP：先手動輸入，之後再接客戶選擇器"})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"客戶名稱（快照）"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"請輸入客戶名稱",...r.getFieldProps("customerName"),required:!0,disabled:s})]}),e.jsxs("div",{className:"col-md-12",children:[e.jsx("label",{className:"form-label",children:"取件地址"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"例如：桃園市蘆竹區...",...r.getFieldProps("pickupAddress"),required:!0,disabled:s})]}),e.jsxs("div",{className:"col-md-12",children:[e.jsx("label",{className:"form-label",children:"送達地址"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"例如：台北市內湖區...",...r.getFieldProps("deliveryAddress"),required:!0,disabled:s})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"預計時段（可選）"}),e.jsx("input",{type:"datetime-local",className:"form-control",...r.getFieldProps("scheduledAt"),disabled:s})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"客戶參考號（可選）"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"客戶端單號/參考號",...r.getFieldProps("customerRefNo"),disabled:s})]}),e.jsxs("div",{className:"col-md-12",children:[e.jsx("label",{className:"form-label",children:"備註（可選）"}),e.jsx("textarea",{className:"form-control",rows:3,placeholder:"補充說明（例如：需冷藏、需堆高機...）",...r.getFieldProps("note"),disabled:s})]})]}),e.jsxs("div",{className:"d-flex justify-content-end gap-3 mt-8",children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:a,disabled:s,children:"取消"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:s,children:s?"建立中…":"建立訂單"})]})]})},B=[{id:"1",orderNo:"TOM-2026-0001",customerName:"宏達國際物流股份有限公司",pickupLocation:"桃園南崁倉",destinationPort:"基隆港",pickupDate:"2026-01-05",containerCount:2,containers:[{containerNo:"OOLU1234567"},{containerNo:"OOLU1234568"}],orderStatus:"CREATED",createdTime:"2026-01-03T09:20:00+08:00"},{id:"2",orderNo:"TOM-2026-0002",customerName:"長榮供應鏈股份有限公司",pickupLocation:"新竹物流園區",destinationPort:"台中港",pickupDate:"2026-01-06",containerCount:1,containers:[{containerNo:"MSCU7654321"}],orderStatus:"assigned",createdTime:"2026-01-03T10:05:00+08:00"},{id:"3",orderNo:"TOM-2026-0003",customerName:"聯合貿易有限公司",pickupLocation:"高雄前鎮加工區",destinationPort:"高雄港",pickupDate:"2026-01-07",containerCount:3,containers:[{containerNo:"TGHU9988776"},{containerNo:"TGHU9988777"},{containerNo:"TGHU9988778"}],orderStatus:"in_transit",createdTime:"2026-01-03T11:30:00+08:00"},{id:"4",orderNo:"TOM-2026-0004",customerName:"亞洲冷鏈物流股份有限公司",pickupLocation:"台北內湖冷鏈倉",destinationPort:"基隆港",pickupDate:"2026-01-08",containerCount:4,containers:[{containerNo:"CMAU4455661"},{containerNo:"CMAU4455662"},{containerNo:"CMAU4455663"},{containerNo:"CMAU4455664"}],orderStatus:"completed",createdTime:"2026-01-02T15:45:00+08:00"},{id:"5",orderNo:"TOM-2026-0005",customerName:"鼎盛貿易股份有限公司",pickupLocation:"台南永康工業區",destinationPort:"安平港",pickupDate:"2026-01-10",containerCount:1,containers:[{containerNo:"HLCU3344556"}],orderStatus:"cancelled",createdTime:"2026-01-01T09:00:00+08:00"}],K="/api/tom/orders";async function ke(s,t){if(U())return console.log("[Mock] 模擬創建訂單",s),await new Promise(a=>setTimeout(a,500)),t==null||t("訂單建立成功 (Mock)","success"),!0;try{return await $.post(K,s),t==null||t("訂單建立成功","success"),!0}catch(a){return console.error(a),t==null||t("建立訂單失敗，請稍後再試","danger"),!1}}async function ce(s,t){if(U())return console.log("[Mock] 使用 Mock 訂單列表",s),await new Promise(a=>setTimeout(a,300)),Promise.resolve({content:B,totalElements:B.length,totalPages:1,size:s.size??10,number:s.page??0,first:(s.page??0)===0,last:!0,empty:B.length===0});try{const r=(await $.get(K,{params:s})).data.data;return{...r,content:r.content||[]}}catch(a){console.error(a);const r=q.fromAxiosError(a);if(r.isServerError)throw r;return t==null||t("取得訂單列表失敗，請稍後再試","danger"),{content:[],totalElements:0,totalPages:0,size:s.size??10,number:s.page??0,first:!0,last:!0,empty:!0}}}async function Te(s,t,a){if(U())return console.log("[Mock] 模擬更新訂單",s,t),await new Promise(l=>setTimeout(l,500)),a==null||a("更新訂單成功 (Mock)","success"),B.find(l=>l.id===s);try{const r=await $.put(`${K}/${s}`,t);return a==null||a("更新訂單成功","success"),r.data.data}catch(r){throw console.error(r),a==null||a("更新訂單失敗，請稍後再試","danger"),r}}async function Se(s,t){if(U())return console.log("[Mock] 模擬刪除訂單",s),await new Promise(a=>setTimeout(a,500)),t==null||t("刪除訂單成功 (Mock)","success"),!0;try{return await $.delete(`${K}/${s}`),t==null||t("刪除訂單成功","success"),!0}catch(a){return console.error(a),t==null||t("刪除訂單失敗，請稍後再試","danger"),!1}}async function Ce(s,t,a){if(U())return console.log("[Mock] 模擬指派訂單",s,t),await new Promise(r=>setTimeout(r,500)),a==null||a("派單成功 (Mock)","success"),!0;try{return await $.post(`${K}/${s}/assign`,t),a==null||a("派單成功","success"),!0}catch(r){return console.error(r),a==null||a("派單失敗，請稍後再試","danger"),!1}}const De=s=>({orderType:s.orderType,customerUuid:H(s.customerUuid),customerName:H(s.customerName),pickupAddress:H(s.pickupAddress),deliveryAddress:H(s.deliveryAddress),scheduledAt:W(s.scheduledAt),customerRefNo:W(s.customerRefNo),note:W(s.note)}),Ee=()=>{const s=_(),{alert:t,showAlert:a,Alert:r}=F(),[l,p]=n.useState(!1),N=n.useCallback(()=>{s(-1)},[s]),x=n.useCallback(async v=>{p(!0);try{if(await ke(De(v),a)){s("/tom/order/list");return}}catch(i){console.error(i),a("系統發生錯誤，請稍後再試","danger")}finally{p(!1)}},[s,a]);return e.jsxs(G,{children:[t&&e.jsx(r,{message:t.message,type:t.type}),e.jsx(V,{title:"建立訂單",breadcrumbs:[{label:"TOM 運輸管理",active:!1},{label:"訂單管理",href:"/tom/order/list",active:!1},{label:"建立訂單",active:!0}]}),e.jsx("div",{className:"container-fluid",children:e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx(ye,{submitting:l,onSubmit:x,onCancel:N})})})})]})},J=s=>{if(!s)return"-";const t=new Date(s);return Number.isNaN(t.getTime())?s:t.toLocaleDateString("zh-TW")},ee=(s,t)=>{const a=s==null?void 0:s.trim(),r=t==null?void 0:t.trim();return!a&&!r?"-":a&&!r?`${a} → -`:!a&&r?`- → ${r}`:`${a} → ${r}`},we=s=>{switch(s){case"CREATED":return{label:"待處理",color:"warning"};case"ASSIGNED":return{label:"已指派",color:"primary"};case"IN_PROGRESS":return{label:"運送中",color:"info"};case"DONE":return{label:"已完成",color:"success"};case"CANCELLED":return{label:"已取消",color:"danger"};default:return{label:s,color:"secondary"}}},Pe=s=>{switch(s){case"UNASSIGNED_TASK":return{label:"未建立/未指派任務",color:"warning",icon:"time"};case"PARTIAL_ASSIGNED":return{label:"部分已指派",color:"primary",icon:"truck"};default:return{label:String(s),color:"secondary",icon:"information-5"}}},Me=()=>{const s=_(),{alert:t,Alert:a}=F(),r=n.useMemo(()=>[{id:"1",orderNo:"TOM-2026-0001",customerName:"宏達國際物流股份有限公司",pickupLocation:"桃園南崁倉",destinationPort:"基隆港",pickupDate:"2026-01-05",containerCount:2,orderStatus:"CREATED",updatedTime:"2026-01-07T09:12:00+08:00"},{id:"2",orderNo:"TOM-2026-0002",customerName:"聯航貨運有限公司",pickupLocation:"新竹物流園區",destinationPort:"台中港",pickupDate:"2026-01-06",containerCount:1,orderStatus:"ASSIGNED",updatedTime:"2026-01-07T10:03:00+08:00"},{id:"3",orderNo:"TOM-2026-0003",customerName:"遠東國際運通",pickupLocation:"台南永康工業區",destinationPort:"安平港",pickupDate:"2026-01-10",containerCount:3,orderStatus:"IN_PROGRESS",updatedTime:"2026-01-07T13:45:00+08:00"},{id:"4",orderNo:"TOM-2026-0004",customerName:"鼎盛供應鏈股份有限公司",pickupLocation:"台北內湖倉",destinationPort:"基隆港",pickupDate:"2026-01-07",containerCount:1,orderStatus:"DONE",updatedTime:"2026-01-07T15:10:00+08:00"}],[]),l=n.useMemo(()=>[{id:"1",orderNo:"TOM-2026-0001",customerName:"宏達國際物流股份有限公司",pickupLocation:"桃園南崁倉",destinationPort:"基隆港",pickupDate:"2026-01-05",containerCount:2,reason:"UNASSIGNED_TASK"},{id:"3",orderNo:"TOM-2026-0003",customerName:"遠東國際運通",pickupLocation:"台南永康工業區",destinationPort:"安平港",pickupDate:"2026-01-10",containerCount:3,reason:"PARTIAL_ASSIGNED"}],[]),p=n.useMemo(()=>{const i=h=>r.filter(b=>b.orderStatus===h).length;return[{title:"待處理",value:i("CREATED"),icon:"time",color:"warning"},{title:"已指派",value:i("ASSIGNED"),icon:"truck",color:"primary"},{title:"運送中",value:i("IN_PROGRESS"),icon:"delivery-3",color:"info"},{title:"已完成",value:i("DONE"),icon:"check-circle",color:"success"}]},[r]),N=()=>s("/tom/order/list"),x=()=>s("/tom/tasks/list"),v=i=>s(`/tom/order/${i}/detail`);return e.jsxs(G,{children:[t&&e.jsx(a,{message:t.message,type:t.type}),e.jsx("div",{id:"kt_app_toolbar",className:"app-toolbar py-3 py-lg-6",children:e.jsxs("div",{id:"kt_app_toolbar_container",className:"app-container container-fluid d-flex flex-stack flex-wrap gap-3",children:[e.jsxs("div",{id:"kt_page_title",className:"page-title d-flex flex-column justify-content-center me-3 min-w-0",children:[e.jsx("h1",{className:"page-heading text-gray-900 fw-bold fs-3 my-0",children:"訂單總覽"}),e.jsxs("ul",{className:"breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0",children:[e.jsx("li",{className:"breadcrumb-item text-muted",children:e.jsx("a",{href:"/tom",className:"text-muted text-hover-primary",children:"訂單管理"})}),e.jsx("li",{className:"breadcrumb-item",children:e.jsx("span",{className:"bullet bg-gray-500 w-5px h-2px"})}),e.jsx("li",{className:"breadcrumb-item text-gray-900",children:"總覽"})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-sm btn-light",onClick:N,children:[e.jsx(f,{iconName:"row-horizontal",className:"fs-3"}),"前往訂單列表"]}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:x,children:[e.jsx(f,{iconName:"truck",className:"fs-3"}),"前往任務管理"]})]})]})}),e.jsxs("div",{className:"app-container container-fluid",children:[e.jsx("div",{className:"row g-5 g-xl-8",children:p.map(i=>e.jsx("div",{className:"col-12 col-sm-6 col-xl-3",children:e.jsx("div",{className:"card h-100",children:e.jsxs("div",{className:"card-body d-flex flex-column justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("span",{className:"text-muted fw-semibold fs-7",children:i.title}),e.jsx("span",{className:"fw-bold fs-2 text-gray-900 mt-1",children:i.value})]}),e.jsx("span",{className:`badge badge-light-${i.color} p-3`,children:e.jsx(f,{iconName:i.icon,className:"fs-2"})})]}),e.jsx("div",{className:"separator my-4"}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("span",{className:"text-muted fs-8",children:"本日"}),e.jsx("span",{className:"text-muted fs-8",children:"mock"})]})]})})},i.title))}),e.jsxs("div",{className:"row g-5 g-xl-8 mt-1",children:[e.jsx("div",{className:"col-12 col-xl-7",children:e.jsxs("div",{className:"card h-100",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"最近訂單"})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("button",{className:"btn btn-sm btn-light",onClick:N,children:"前往列表"})})]}),e.jsxs("div",{className:"card-body py-4",children:[e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"fw-bold text-muted",children:[e.jsx("th",{className:"min-w-150px",children:"訂單編號"}),e.jsx("th",{className:"min-w-180px",children:"客戶"}),e.jsx("th",{className:"min-w-240px",children:"路線"}),e.jsx("th",{className:"min-w-110px text-end",children:"櫃數"}),e.jsx("th",{className:"min-w-120px",children:"狀態"}),e.jsx("th",{className:"min-w-120px",children:"更新"})]})}),e.jsx("tbody",{children:r.map(i=>{const h=we(i.orderStatus);return e.jsxs("tr",{className:"cursor-pointer table-row-hover",onClick:()=>v(i.id),children:[e.jsx("td",{className:"fw-bold text-gray-900",children:i.orderNo}),e.jsx("td",{children:i.customerName}),e.jsx("td",{children:ee(i.pickupLocation,i.destinationPort)}),e.jsx("td",{className:"text-end",children:i.containerCount}),e.jsx("td",{children:e.jsx("span",{className:`badge badge-light-${h.color}`,children:h.label})}),e.jsx("td",{className:"text-muted",children:J(i.updatedTime)})]},i.id)})})]})}),e.jsx("div",{className:"text-muted fs-8 mt-2",children:"* MVP：目前為 mock 資料，之後接 API 後改為「最近建立/更新」。"})]})]})}),e.jsx("div",{className:"col-12 col-xl-5",children:e.jsxs("div",{className:"card h-100",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"待派單"})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("button",{className:"btn btn-sm btn-light",onClick:x,children:"前往任務管理"})})]}),e.jsxs("div",{className:"card-body py-4",children:[l.length===0?e.jsx("div",{className:"text-muted",children:"目前沒有待派單項目"}):e.jsx("div",{className:"d-flex flex-column gap-3",children:l.map(i=>{const h=Pe(i.reason);return e.jsxs("div",{className:"d-flex align-items-center justify-content-between border rounded p-3",children:[e.jsxs("div",{className:"d-flex flex-column min-w-0",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"fw-bold text-gray-900",children:i.orderNo}),e.jsx("span",{className:`badge badge-light-${h.color}`,children:h.label})]}),e.jsx("div",{className:"text-muted fs-8 mt-1 text-truncate",children:i.customerName}),e.jsx("div",{className:"text-muted fs-8 text-truncate",children:ee(i.pickupLocation,i.destinationPort)}),e.jsxs("div",{className:"text-muted fs-8 mt-1",children:["提貨：",J(i.pickupDate),"｜櫃數：",i.containerCount]})]}),e.jsxs("div",{className:"d-flex gap-2 flex-shrink-0",children:[e.jsxs("button",{className:"btn btn-sm btn-light",onClick:()=>v(i.id),children:[e.jsx(f,{iconName:"eye",className:"fs-3"}),"訂單"]}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:x,children:[e.jsx(f,{iconName:h.icon,className:"fs-3"}),"派單"]})]})]},i.id)})}),e.jsx("div",{className:"text-muted fs-8 mt-3",children:"* MVP：待派單來源建議以「任務未指派 / 部分未指派」彙總，而非只看訂單狀態。"})]})]})})]})]})]})},Le=10,Oe=s=>s?new Date(s).toLocaleDateString("zh-TW"):"-",Re=s=>{if(!s)return{label:"-",className:"badge-light-secondary"};switch(s){case"CREATED":return{label:"新建立",className:"badge-light-info"};case"pending":return{label:"待處理",className:"badge-light-warning"};case"assigned":return{label:"已指派",className:"badge-light-primary"};case"in_transit":return{label:"運送中",className:"badge-light-primary"};case"completed":return{label:"已完成",className:"badge-light-success"};case"cancelled":return{label:"已取消",className:"badge-light-danger"};default:return{label:s,className:"badge-light-secondary"}}},Ie=(s,t)=>{const a=s==null?void 0:s.trim(),r=t==null?void 0:t.trim();return!a&&!r?"-":a&&!r?`${a} -> -`:!a&&r?`- -> ${r}`:`${a} -> ${r}`},Ue=s=>{if(typeof(s==null?void 0:s.containerCount)=="number")return s.containerCount;if(Array.isArray(s==null?void 0:s.containers))return s.containers.length;const t=String((s==null?void 0:s.containerNumber)??"").trim();return t&&t.split(/[,|]/).map(r=>r.trim()).filter(Boolean).length||0},$e=({searchKeyword:s,showAlert:t,onEdit:a,onAssign:r})=>{const l=_(),[p,N]=n.useState([]),[x,v]=n.useState(0),[i,h]=n.useState(1),[b,u]=n.useState(1),[m,T]=n.useState(!1),[y,c]=n.useState(null),[g,k]=n.useState(!1),[o,j]=n.useState(!1),[D,S]=n.useState(!1),E=n.useCallback(async()=>{T(!0),j(!1);try{const d={page:b-1,size:Le,keyword:s!=null&&s.trim()?s.trim():void 0},P=await ce(d,t);N(P.content),v(P.totalElements),h(P.totalPages||1)}catch(d){q.fromAxiosError(d).isServerError?(j(!0),S(!0)):t("取得訂單列表失敗，請稍後再試","danger")}finally{T(!1)}},[b,s,t]),Q=n.useCallback(()=>{te(),S(!1),j(!1),E()},[E]),le=n.useCallback(()=>{j(!1),E()},[E]);n.useEffect(()=>{u(1)},[s]),n.useEffect(()=>{E()},[E]);const X=n.useCallback(d=>{l(`/tom/order/${d.id}/detail`)},[l]),de=d=>c(d),oe=async()=>{if(!y)return;const d=y.id;if(!d){t("缺少訂單識別碼，無法刪除","danger");return}try{k(!0),await Se(String(d),t)&&(await E(),c(null))}finally{k(!1)}};if(o)return e.jsxs(e.Fragment,{children:[e.jsx(re,{onRetry:le,showMockOption:!0,onUseMock:Q}),e.jsx(ne,{open:D,onConfirm:Q,onCancel:()=>S(!1)})]});const me=[{header:"訂單編號",className:"min-w-150px"},{header:"客戶名稱",className:"min-w-180px"},{header:"起始地點 -> 目的港口",className:"min-w-260px"},{header:"提貨日期",className:"min-w-120px"},{header:"貨櫃數量",className:"min-w-110px text-end"},{header:"狀態",className:"min-w-110px"},{header:"操作",className:"text-end min-w-200px"}];return e.jsxs(e.Fragment,{children:[e.jsx(ie,{columns:me,rows:p,loading:m,emptyText:"沒有訂單資料",page:b,totalPages:i,totalElements:x,onPrev:()=>u(d=>Math.max(1,d-1)),onNext:()=>u(d=>Math.min(i||1,d+1)),renderRow:d=>{var Z;const P=d.customerName??((Z=d.customer)==null?void 0:Z.name)??d.customerUuid??"-",ue=d.pickupLocation??d.originLocation??d.startLocation,xe=d.destinationPort??d.destPort??d.endPort,he=d.pickupDate??d.pickupTime??d.pickupAt??d.pickupPlanDate,pe=Ue(d),Y=Re(d.orderStatus);return e.jsxs("tr",{className:"cursor-pointer table-row-hover",onClick:()=>X(d),children:[e.jsx("td",{className:"fw-bold text-gray-900",children:d.orderNo??"-"}),e.jsx("td",{children:P}),e.jsx("td",{children:Ie(ue,xe)}),e.jsx("td",{children:Oe(he)}),e.jsx("td",{className:"text-end",children:pe||0}),e.jsx("td",{children:e.jsx("span",{className:`badge ${Y.className} fw-bold`,children:Y.label})}),e.jsx("td",{className:"text-end",onClick:w=>w.stopPropagation(),children:e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx("button",{className:"btn btn-light-primary btn-sm",onClick:w=>{w.preventDefault(),X(d)},title:"查看詳情",children:e.jsx(f,{iconName:"eye",className:"fs-2"})}),a&&e.jsx("button",{className:"btn btn-light-warning btn-sm",onClick:w=>{w.preventDefault(),a(d)},title:"編輯",children:e.jsx(f,{iconName:"message-edit",className:"fs-2"})}),r&&e.jsx("button",{className:"btn btn-light-info btn-sm",onClick:w=>{w.preventDefault(),r(d)},title:"派單",children:e.jsx(f,{iconName:"truck",className:"fs-2"})}),e.jsx("button",{className:"btn btn-light-danger btn-sm",onClick:w=>{w.preventDefault(),de(d)},title:"刪除",children:e.jsx(f,{iconName:"trash",className:"fs-2"})})]})})]},String(d.id??Math.random()))}}),y&&e.jsx(ge,{open:!!y,title:"刪除訂單",deleting:g,message:e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["確定要刪除訂單 ",e.jsx("strong",{children:y.id??"-"})," 嗎？"]}),e.jsx("p",{className:"text-muted mb-0",children:"此操作無法復原，請再次確認。"})]}),onClose:()=>g?null:c(null),onConfirm:oe})]})},se=s=>s.trim(),_e=({open:s,onClose:t,onSaved:a,showAlert:r,editingOrder:l})=>{const p=!!l,[N,x]=n.useState("export"),[v,i]=n.useState(""),[h,b]=n.useState(""),[u,m]=n.useState(""),[T,y]=n.useState(""),[c,g]=n.useState(!1);n.useEffect(()=>{if(s){if(!l){x("export"),i(""),b(""),m(""),y("");return}x("export"),b("")}},[s,l]);const k=()=>N?v===""||Number.isNaN(Number(v))?(r("請輸入客戶 ID（customerId）","warning"),!1):se(h)?u?!0:(r("請選擇日期（shipDate）","warning"),!1):(r("請輸入櫃號（containerNumber）","warning"),!1):(r("請選擇訂單類型","warning"),!1),o=async()=>{if(k())try{if(g(!0),p&&l){const j={orderType:N,customerId:String(v),containerNumber:se(h),shipDate:u,note:T.trim()||void 0};await Te(l.id,j,r)}else r("請使用建立訂單頁面來建立新訂單","info");a()}catch(j){console.error(j),r("儲存失敗，請稍後再試","danger")}finally{g(!1)}};return s?e.jsx("div",{className:"modal fade show d-block",tabIndex:-1,style:{backgroundColor:"rgba(0,0,0,.25)"},role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx(f,{iconName:p?"message-edit":"plus",className:"fs-2 me-2"}),p?"編輯訂單":"建立訂單"]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-light",onClick:t,disabled:c,"aria-label":"Close",children:"×"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"row g-5",children:[e.jsxs("div",{className:"col-12 col-md-6 d-flex flex-column gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label required",children:"訂單類型（orderType）"}),e.jsxs("select",{className:"form-select",value:N,onChange:j=>x(j.target.value),children:[e.jsx("option",{value:"export",children:"出口"}),e.jsx("option",{value:"import",children:"進口"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label required",children:"客戶 ID（customerId）"}),e.jsx("input",{className:"form-control",value:v,onChange:j=>{const D=j.target.value;i(D===""?"":Number(D))},placeholder:"例如：1001",inputMode:"numeric"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label required",children:"日期（shipDate）"}),e.jsx("input",{className:"form-control",type:"date",value:u,onChange:j=>m(j.target.value)})]})]}),e.jsxs("div",{className:"col-12 col-md-6 d-flex flex-column gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label required",children:"櫃號（containerNumber）"}),e.jsx("input",{className:"form-control",value:h,onChange:j=>b(j.target.value),placeholder:"例如：TGHU1234567",autoFocus:!p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"備註（note）"}),e.jsx("textarea",{className:"form-control",rows:5,value:T,onChange:j=>y(j.target.value),placeholder:"可留空"})]})]})]}),e.jsx("div",{className:"text-muted fs-8 mt-4",children:"v1 先做最小可用欄位；進口/出口完整欄位（船名航次、結關日、領櫃/還櫃等）將於 v2 擴充。"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-light",onClick:t,disabled:c,children:"取消"}),e.jsx("button",{className:"btn btn-primary",onClick:o,disabled:c,children:c?"儲存中…":"儲存"})]})]})})}):null};function Ae(){const{alert:s,showAlert:t,Alert:a}=F(),r=_(),[l,p]=n.useState(""),[N,x]=n.useState(""),[v,i]=n.useState(0),[h,b]=n.useState(!1),[u,m]=n.useState(null),T=k=>{k.key==="Enter"&&p(N.trim())},y=()=>{i(k=>k+1),b(!1),m(null)},c=()=>{r("/tom/order/create")},g=k=>{m(k),b(!0)};return n.useEffect(()=>{},[t]),e.jsxs(G,{children:[s&&e.jsx(a,{message:s.message,type:s.type}),e.jsx(V,{title:"訂單列表",breadcrumbs:[{label:"訂單管理",href:"#"},{label:"訂單列表",active:!0}]}),e.jsx("div",{className:"flex-column-fluid",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsx("div",{className:"card-title",children:e.jsxs("div",{className:"d-flex align-items-center position-relative my-1",children:[e.jsx(f,{iconName:"magnifier",className:"fs-1 position-absolute ms-6"}),e.jsx("input",{type:"text",className:"form-control form-control-solid w-250px ps-14",placeholder:"訂單編號 / 櫃號 / 船名航次…",value:N,onChange:k=>x(k.target.value),onKeyDown:T})]})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("div",{className:"d-flex justify-content-end gap-2 flex-wrap",children:e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:c,children:[e.jsx(f,{iconName:"plus",className:"fs-2"}),"建立訂單"]})})})]}),e.jsx("div",{className:"card-body py-4",children:e.jsx($e,{searchKeyword:l,showAlert:t,onEdit:g,onAssign:g},v)})]})}),e.jsx(_e,{open:h,onClose:()=>{b(!1),m(null)},showAlert:t,editingOrder:u,onSaved:y})]})}const Fe={1:{id:"1",orderNo:"TOM-2026-0001",customerName:"宏達國際物流股份有限公司",pickupLocation:"桃園南崁倉",destinationPort:"基隆港",pickupDate:"2026-01-05",containerCount:5,orderStatus:"CREATED",createdTime:"2026-01-03T09:20:00+08:00",containers:[{containerNo:"OOLU1234567",containerType:"20GP",weightKg:12800,remark:"一般貨"},{containerNo:"OOLU1234568",containerType:"20GP",weightKg:13150,remark:"需注意破損"},{containerNo:"MSCU7654321",containerType:"40HQ",weightKg:17320,remark:"高價貨，勿碰撞"},{containerNo:"TGHU9988776",containerType:"40HQ",weightKg:18100,remark:"需等待裝櫃完成通知"},{containerNo:"CMAU4455661",containerType:"45HQ",weightKg:16580,remark:"裝卸需預留人力"}],billing:{pricingMode:"PER_CONTAINER",paymentTerm:"MONTHLY",paymentStatus:"UNBILLED",currency:"TWD",subtotal:42500,tax:2125,total:44625,invoiceNeeded:!0,invoiceTitle:"宏達國際物流股份有限公司",taxId:"12345678",remark:"月結 30 天；吊櫃費用另計（如現場發生則加收）"},dispatch:{status:"UNASSIGNED",vehicleNo:void 0,driverName:void 0,assignedAt:void 0,etaAt:"2026-01-05T08:30:00+08:00",remark:"預計 08:30 到場，待指派車輛/司機"},logs:[{time:"2026-01-03T09:20:00+08:00",action:"CREATED",operator:"內勤-小林",remark:"建立訂單，已確認起訖與提貨日期"},{time:"2026-01-03T10:10:00+08:00",action:"CONTAINERS_UPDATED",operator:"內勤-小林",remark:"更新貨櫃清單（共 5 櫃）"},{time:"2026-01-03T11:00:00+08:00",action:"BILLING_DRAFTED",operator:"財務-雅婷",remark:"建立計費草稿：按櫃計費、月結"},{time:"2026-01-04T17:30:00+08:00",action:"DISPATCH_PENDING",operator:"調度-阿宏",remark:"待確認車況與司機班表，隔日早上派車"}]},2:{id:"2",orderNo:"TOM-2026-0002",customerName:"長榮供應鏈股份有限公司",pickupLocation:"新竹物流園區",destinationPort:"台中港",pickupDate:"2026-01-06",containerCount:2,orderStatus:"assigned",createdTime:"2026-01-03T10:05:00+08:00",containers:[{containerNo:"HLCU3344556",containerType:"40HQ",weightKg:19240,remark:"需冷鏈（溫控文件補上）"},{containerNo:"HLCU3344557",containerType:"40HQ",weightKg:18890,remark:"同車同趟"}],billing:{pricingMode:"PER_ORDER",paymentTerm:"TRANSFER",paymentStatus:"BILLED",currency:"TWD",subtotal:18e3,tax:900,total:18900,invoiceNeeded:!1,remark:"已請款，待入帳確認"},dispatch:{status:"ASSIGNED",vehicleNo:"KAA-7788",driverName:"陳大偉",assignedAt:"2026-01-05T15:00:00+08:00",etaAt:"2026-01-06T07:50:00+08:00",remark:"司機已確認；到場後先與倉管聯繫"},logs:[{time:"2026-01-03T10:05:00+08:00",action:"CREATED",operator:"內勤-小張",remark:"建立訂單"},{time:"2026-01-05T15:00:00+08:00",action:"ASSIGNED",operator:"調度-阿宏",remark:"指派車輛 KAA-7788、司機 陳大偉"},{time:"2026-01-05T16:20:00+08:00",action:"BILLED",operator:"財務-雅婷",remark:"已開立請款資料（匯款）"}]},3:{id:"3",orderNo:"TOM-2026-0003",customerName:"聯合貿易有限公司",pickupLocation:"高雄前鎮加工區",destinationPort:"高雄港",pickupDate:"2026-01-07",containerCount:1,orderStatus:"in_transit",createdTime:"2026-01-03T11:30:00+08:00",containers:[{containerNo:"TGHU9988777",containerType:"20GP",weightKg:11420,remark:"一般貨"}],billing:{pricingMode:"PER_TRIP",paymentTerm:"COD",paymentStatus:"BILLED",currency:"TWD",subtotal:8500,tax:425,total:8925,invoiceNeeded:!0,invoiceTitle:"聯合貿易有限公司",taxId:"87654321",remark:"到付；現場簽收後收款"},dispatch:{status:"IN_PROGRESS",vehicleNo:"KBC-5566",driverName:"林志豪",assignedAt:"2026-01-06T18:10:00+08:00",etaAt:"2026-01-07T09:00:00+08:00",remark:"已進場；等待裝卸完成"},logs:[{time:"2026-01-03T11:30:00+08:00",action:"CREATED",operator:"內勤-小林"},{time:"2026-01-06T18:10:00+08:00",action:"ASSIGNED",operator:"調度-阿宏",remark:"指派車輛 KBC-5566、司機 林志豪"},{time:"2026-01-07T08:55:00+08:00",action:"IN_PROGRESS",operator:"司機-林志豪",remark:"抵達取貨地點，等待進場"}]},4:{id:"4",orderNo:"TOM-2026-0004",customerName:"亞洲冷鏈物流股份有限公司",pickupLocation:"台北內湖冷鏈倉",destinationPort:"基隆港",pickupDate:"2026-01-08",containerCount:3,orderStatus:"completed",createdTime:"2026-01-02T15:45:00+08:00",containers:[{containerNo:"CMAU4455662",containerType:"40RH",weightKg:16900,remark:"冷鏈 RH（需溫度紀錄）"},{containerNo:"CMAU4455663",containerType:"40RH",weightKg:17120,remark:"冷鏈 RH（同趟）"},{containerNo:"CMAU4455664",containerType:"40RH",weightKg:16850,remark:"冷鏈 RH（同趟）"}],billing:{pricingMode:"PACKAGE",paymentTerm:"MONTHLY",paymentStatus:"PAID",currency:"TWD",subtotal:52e3,tax:2600,total:54600,invoiceNeeded:!0,invoiceTitle:"亞洲冷鏈物流股份有限公司",taxId:"24682468",remark:"已收款；溫度紀錄檔已提供"},dispatch:{status:"DONE",vehicleNo:"KAD-9090",driverName:"張家豪",assignedAt:"2026-01-07T13:30:00+08:00",etaAt:"2026-01-08T07:30:00+08:00",remark:"已完成；回傳簽收與照片"},logs:[{time:"2026-01-02T15:45:00+08:00",action:"CREATED",operator:"內勤-小張"},{time:"2026-01-07T13:30:00+08:00",action:"ASSIGNED",operator:"調度-阿宏",remark:"已派車"},{time:"2026-01-08T07:35:00+08:00",action:"IN_PROGRESS",operator:"司機-張家豪",remark:"到場取貨"},{time:"2026-01-08T11:20:00+08:00",action:"COMPLETED",operator:"司機-張家豪",remark:"已送達並簽收"},{time:"2026-01-10T10:00:00+08:00",action:"PAID",operator:"財務-雅婷",remark:"已入帳"}]},5:{id:"5",orderNo:"TOM-2026-0005",customerName:"鼎盛貿易股份有限公司",pickupLocation:"台南永康工業區",destinationPort:"安平港",pickupDate:"2026-01-10",containerCount:1,orderStatus:"cancelled",createdTime:"2026-01-01T09:00:00+08:00",containers:[{containerNo:"OOLU8888999",containerType:"20GP",weightKg:9800,remark:"客戶取消"}],billing:{pricingMode:"PER_ORDER",paymentTerm:"TRANSFER",paymentStatus:"UNBILLED",currency:"TWD",subtotal:0,tax:0,total:0,invoiceNeeded:!1,remark:"已取消，未產生費用"},dispatch:{status:"CANCELLED",remark:"客戶於提貨前一天取消"},logs:[{time:"2026-01-01T09:00:00+08:00",action:"CREATED",operator:"內勤-小林"},{time:"2026-01-09T16:10:00+08:00",action:"CANCELLED",operator:"內勤-小林",remark:"客戶通知取消，未派車"}]}},Ge="/api/tom/orders";async function Ke(s,t){if(U()){console.log("[Mock] 使用 Mock 訂單詳情",s),await new Promise(r=>setTimeout(r,300));const a=Fe[s];return a?Promise.resolve(a):(t==null||t("訂單不存在 (Mock)","warning"),null)}try{return(await $.get(`${Ge}/${s}`)).data.data??null}catch(a){console.error(a);const r=q.fromAxiosError(a);if(r.isServerError)throw r;return t==null||t("取得訂單詳情失敗，請稍後再試","danger"),null}}const R=s=>s==null||s===""?"-":String(s),He=s=>{if(!s)return"badge-light-secondary";const t=s.toLowerCase();return t.includes("created")||t.includes("新建立")?"badge-light-info":t.includes("pending")||t.includes("待處理")?"badge-light-warning":t.includes("assigned")||t.includes("已指派")||t.includes("in_transit")||t.includes("運送中")?"badge-light-primary":t.includes("completed")||t.includes("已完成")?"badge-light-success":t.includes("cancelled")||t.includes("已取消")?"badge-light-danger":"badge-light-secondary"},Be=({detail:s})=>e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"訂單摘要"})})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted w-150px",children:"訂單編號"}),e.jsx("td",{className:"fw-semibold",children:R(s.orderNo)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"客戶名稱"}),e.jsx("td",{className:"fw-semibold",children:R(s.customerName)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"起始地點 → 結束地點"}),e.jsxs("td",{className:"fw-semibold",children:[R(s.pickupLocation)," → ",R(s.destinationPort)]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"提貨日期"}),e.jsx("td",{className:"fw-semibold",children:R(s.pickupDate)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"訂單狀態"}),e.jsx("td",{className:"fw-semibold",children:e.jsx("span",{className:`badge ${He(s.orderStatus)} fw-bold`,children:R(s.orderStatus)})})]})]})})})})]}),ze=s=>{if(!s)return"badge-light-secondary";const t=s.toLowerCase();return t.includes("ready")||t.includes("就緒")||t.includes("待運")?"badge-light-info":t.includes("loading")||t.includes("裝載中")?"badge-light-warning":t.includes("in_transit")||t.includes("運送中")?"badge-light-primary":t.includes("delivered")||t.includes("已送達")||t.includes("完成")?"badge-light-success":t.includes("damaged")||t.includes("損壞")||t.includes("異常")?"badge-light-danger":"badge-light-secondary"},Ve=({detail:s})=>{const t=s.containers||[];return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"貨櫃清單"})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("button",{className:"btn btn-sm btn-light-primary",type:"button",disabled:!0,children:"新增貨櫃（待開發）"})})]}),e.jsxs("div",{className:"card-body",children:[t.length===0?e.jsx("div",{className:"text-muted",children:"尚無貨櫃資料（後續可從 detail.containers 帶入）"}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-muted fw-bold",children:[e.jsx("th",{className:"min-w-180px",children:"編號"}),e.jsx("th",{className:"min-w-120px",children:"類型"}),e.jsx("th",{className:"min-w-120px",children:"狀態"}),e.jsx("th",{className:"min-w-200px",children:"特殊注記"})]})}),e.jsx("tbody",{children:t.map((a,r)=>e.jsxs("tr",{children:[e.jsx("td",{className:"fw-semibold",children:a.containerNo}),e.jsx("td",{children:a.containerType??"-"}),e.jsx("td",{children:a.status?e.jsx("span",{className:`badge ${ze(a.status)} fw-bold`,children:a.status}):"-"}),e.jsx("td",{children:a.remark??"-"})]},`${a.containerNo}-${r}`))})]})}),e.jsxs("div",{className:"text-muted fs-8 mt-3",children:["目前貨櫃數量：",t.length,"（或使用 detail.containerCount：",s.containerCount,"）"]})]})]})},C=s=>s==null||s===""?"-":String(s),qe=({detail:s})=>{const t=s.billing;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"計費與支付方式"})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("button",{className:"btn btn-sm btn-light-warning",type:"button",disabled:!0,children:"編輯（待開發）"})})]}),e.jsx("div",{className:"card-body",children:t?e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted w-150px",children:"計費方式"}),e.jsx("td",{className:"fw-semibold",children:C(t.pricingMode)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"付款條件"}),e.jsx("td",{className:"fw-semibold",children:C(t.paymentTerm)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"付款狀態"}),e.jsx("td",{className:"fw-semibold",children:C(t.paymentStatus)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"小計"}),e.jsxs("td",{className:"fw-semibold",children:[C(t.subtotal)," ",C(t.currency)]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"稅額"}),e.jsxs("td",{className:"fw-semibold",children:[C(t.tax)," ",C(t.currency)]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"總計"}),e.jsxs("td",{className:"fw-semibold",children:[C(t.total)," ",C(t.currency)]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"需要發票"}),e.jsx("td",{className:"fw-semibold",children:C(t.invoiceNeeded)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"抬頭/統編"}),e.jsxs("td",{className:"fw-semibold",children:[C(t.invoiceTitle)," / ",C(t.taxId)]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"備註"}),e.jsx("td",{className:"fw-semibold",children:C(t.remark)})]})]})})}):e.jsx("div",{className:"text-muted",children:"尚未建立計費資料（後續從 detail.billing 帶入）"})})]})},L=s=>s==null||s===""?"-":String(s),We=s=>{if(!s)return"badge-light-secondary";const t=s.toLowerCase();return t.includes("unassigned")||t.includes("未指派")?"badge-light-secondary":t.includes("assigned")||t.includes("已指派")?"badge-light-info":t.includes("in_progress")||t.includes("進行中")?"badge-light-primary":t.includes("done")||t.includes("完成")?"badge-light-success":t.includes("cancelled")||t.includes("已取消")?"badge-light-danger":"badge-light-secondary"},Qe=({detail:s})=>{const t=s.dispatch;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"派車資訊"})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("button",{className:"btn btn-sm btn-light-primary",type:"button",disabled:!0,children:"指派（待開發）"})})]}),e.jsx("div",{className:"card-body",children:t?e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted w-150px",children:"車頭"}),e.jsx("td",{className:"fw-semibold",children:L(t.vehicleNo)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"板車"}),e.jsx("td",{className:"fw-semibold",children:L(t.trailerNo)||"-"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"司機"}),e.jsx("td",{className:"fw-semibold",children:L(t.driverName)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"執行狀態"}),e.jsx("td",{className:"fw-semibold",children:t.status?e.jsx("span",{className:`badge ${We(t.status)} fw-bold`,children:L(t.status)}):"-"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"指派時間"}),e.jsx("td",{className:"fw-semibold",children:L(t.assignedAt)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"預計到場"}),e.jsx("td",{className:"fw-semibold",children:L(t.etaAt)})]}),t.remark&&e.jsxs("tr",{children:[e.jsx("td",{className:"text-muted",children:"備註"}),e.jsx("td",{className:"fw-semibold",children:L(t.remark)})]})]})})}):e.jsx("div",{className:"text-muted",children:"尚未指派"})})]})},Xe=({detail:s})=>{const t=s.logs||[];return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:e.jsx("h3",{className:"fw-bold m-0",children:"狀態歷程"})})}),e.jsx("div",{className:"card-body",children:t.length===0?e.jsx("div",{className:"text-muted",children:"尚無紀錄（後續從 detail.logs 帶入）"}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-row-dashed table-row-gray-300 align-middle gs-0 gy-3",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-muted fw-bold",children:[e.jsx("th",{className:"min-w-160px",children:"時間"}),e.jsx("th",{className:"min-w-140px",children:"動作"}),e.jsx("th",{className:"min-w-140px",children:"操作者"}),e.jsx("th",{className:"min-w-200px",children:"備註"})]})}),e.jsx("tbody",{children:t.map((a,r)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.time}),e.jsx("td",{className:"fw-semibold",children:a.action}),e.jsx("td",{children:a.operator??"-"}),e.jsx("td",{children:a.remark??"-"})]},`${a.time}-${r}`))})]})})})]})},Ye=()=>{const{id:s}=Ne(),{alert:t,showAlert:a,Alert:r}=F(),[l,p]=n.useState(!0),[N,x]=n.useState(null),[v,i]=n.useState(!1),[h,b]=n.useState(!1),u=n.useCallback(async()=>{if(!s){x(null),p(!1);return}p(!0),i(!1);try{const y=await Ke(s,a);x(y)}catch(y){console.error(y),q.fromAxiosError(y).isServerError?(i(!0),b(!0)):(a("取得訂單詳情失敗","danger"),x(null))}finally{p(!1)}},[s,a]),m=n.useCallback(()=>{te(),b(!1),i(!1),u()},[u]),T=n.useCallback(()=>{i(!1),u()},[u]);return n.useEffect(()=>{u()},[u]),v?e.jsxs(e.Fragment,{children:[e.jsx(re,{onRetry:T,showMockOption:!0,onUseMock:m}),e.jsx(ne,{open:h,onConfirm:m,onCancel:()=>b(!1)})]}):e.jsxs(G,{children:[t&&e.jsx(r,{message:t.message,type:t.type}),e.jsx(V,{title:"訂單詳情",breadcrumbs:[{label:"訂單管理",href:"/tom"},{label:"訂單",href:"/tom/order"},{label:"詳情",active:!0}]}),e.jsx("div",{className:"app-container container-fluid",children:l?e.jsx("div",{className:"d-flex justify-content-center py-10",children:e.jsx(z,{animation:"border"})}):N?e.jsxs("div",{className:"row g-6",children:[e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(Be,{detail:N,reload:u})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(qe,{detail:N,reload:u})}),e.jsx("div",{className:"col-12",children:e.jsx(Ve,{detail:N,reload:u})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(Qe,{detail:N,reload:u})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsx(Xe,{detail:N})})]}):e.jsx("div",{className:"text-center py-10 text-muted",children:"查無訂單資料"})})]})},Ze=10,Je=s=>s?new Date(s).toLocaleDateString("zh-TW"):"-",es=s=>{if(!s)return"-";switch(s){case"CREATED":case"pending":return"待處理";case"assigned":return"已指派";case"in_transit":return"運送中";case"completed":return"已完成";case"cancelled":return"已取消";default:return s}},ss=(s,t)=>{const a=s==null?void 0:s.trim(),r=t==null?void 0:t.trim();return!a&&!r?"-":a&&!r?`${a} -> -`:!a&&r?`- -> ${r}`:`${a} -> ${r}`},ts=s=>{if(typeof(s==null?void 0:s.containerCount)=="number")return s.containerCount;if(Array.isArray(s==null?void 0:s.containers))return s.containers.length;const t=String((s==null?void 0:s.containerNumber)??"").trim();return t&&t.split(/[,|]/).map(r=>r.trim()).filter(Boolean).length||0},as=({showAlert:s,onAssign:t})=>{const a=_(),[r,l]=n.useState([]),[p,N]=n.useState(0),[x,v]=n.useState(1),[i,h]=n.useState(1),[b,u]=n.useState(!1),m=n.useCallback(async()=>{u(!0);try{const c={page:i-1,size:Ze,status:"pending"},g=await ce(c,s),k=g.content.filter(o=>o.orderStatus==="pending"||o.orderStatus==="CREATED");l(k),N(k.length),v(g.totalPages||1)}catch(c){console.error("載入待指派訂單失敗:",c),s("載入待指派訂單失敗","danger"),l([])}finally{u(!1)}},[i,s]);n.useEffect(()=>{h(1)},[]),n.useEffect(()=>{m()},[m]);const T=n.useCallback(c=>{a(`/tom/order/${c.id}/detail`)},[a]),y=[{header:"訂單編號",className:"min-w-150px"},{header:"客戶名稱",className:"min-w-180px"},{header:"起始地點 -> 目的港口",className:"min-w-260px"},{header:"提貨日期",className:"min-w-120px"},{header:"貨櫃數量",className:"min-w-110px text-end"},{header:"狀態",className:"min-w-110px"},{header:"操作",className:"min-w-200px"}];return b&&r.length===0?e.jsx("div",{className:"d-flex justify-content-center py-10",children:e.jsx(z,{animation:"border"})}):e.jsx(e.Fragment,{children:r.length===0?e.jsxs("div",{className:"text-center py-10 text-muted",children:[e.jsx(f,{iconName:"information-5",className:"fs-3x mb-3 text-muted"}),e.jsx("p",{children:"目前沒有待指派的訂單"})]}):e.jsx(ie,{columns:y,rows:r,loading:b,emptyText:"沒有待指派訂單",page:i,totalPages:x,totalElements:p,onPrev:()=>h(c=>Math.max(1,c-1)),onNext:()=>h(c=>Math.min(x||1,c+1)),renderRow:c=>{var S;const g=c.customerName??((S=c.customer)==null?void 0:S.name)??c.customerUuid??"-",k=c.pickupLocation??c.originLocation??c.startLocation,o=c.destinationPort??c.destPort??c.endPort,j=c.pickupDate??c.pickupTime??c.pickupAt??c.pickupPlanDate,D=ts(c);return e.jsxs("tr",{className:"cursor-pointer table-row-hover",onClick:()=>T(c),children:[e.jsx("td",{className:"fw-bold text-gray-900",children:c.orderNo??c.id??"-"}),e.jsx("td",{children:g}),e.jsx("td",{children:ss(k,o)}),e.jsx("td",{children:Je(j)}),e.jsx("td",{className:"text-end",children:D||0}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-warning",children:es(c.orderStatus)})}),e.jsxs("td",{children:[e.jsxs("button",{className:"btn btn-sm btn-success me-2",onClick:E=>{E.stopPropagation(),T(c)},children:[e.jsx(f,{iconName:"eye",className:"fs-2"}),"詳情"]}),t&&e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:E=>{E.stopPropagation(),t(c)},children:[e.jsx(f,{iconName:"truck",className:"fs-2"}),"指派"]})]})]},String(c.id??Math.random()))}})})},rs=({open:s,order:t,onClose:a,onSuccess:r,showAlert:l})=>{const[p,N]=n.useState([]),[x,v]=n.useState([]),[i,h]=n.useState(!1),[b,u]=n.useState(!1),[m,T]=n.useState(!1),y=n.useCallback(async()=>{h(!0);try{const D=(await fe({page:0,size:100},l)).content.filter(S=>S.status==="AVAILABLE"||S.status==="IDLE"||S.enabled);N(D)}catch(o){console.error("載入車輛列表失敗:",o),l("載入車輛列表失敗","danger")}finally{h(!1)}},[l]),c=n.useCallback(async()=>{u(!0);try{const D=(await ve({page:0,size:100},l)).content.filter(S=>S.status==="ACTIVE"&&S.onDuty);v(D)}catch(o){console.error("載入司機列表失敗:",o),l("載入司機列表失敗","danger")}finally{u(!1)}},[l]);n.useEffect(()=>{s&&(y(),c())},[s,y,c]);const g=ae({initialValues:{vehicleId:"",driverId:""},onSubmit:async o=>{if(!o.vehicleId||!o.driverId){l("請選擇車輛和司機","warning");return}T(!0);try{const j={vehicleId:o.vehicleId,driverId:o.driverId};await Ce(String(t.id),j,l)&&(r(),g.resetForm())}catch(j){console.error("指派訂單失敗:",j),l("指派訂單失敗，請稍後再試","danger")}finally{T(!1)}}}),k=n.useCallback(()=>{m||(g.resetForm(),a())},[g,a,m]);return e.jsx(A,{show:s,onHide:k,size:"lg",backdrop:!m,children:e.jsxs("form",{onSubmit:g.handleSubmit,children:[e.jsx(A.Header,{closeButton:!m,children:e.jsxs(A.Title,{children:[e.jsx(f,{iconName:"truck",className:"fs-2 me-2 text-primary"}),"指派訂單"]})}),e.jsxs(A.Body,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h5",{className:"mb-3",children:"訂單資訊"}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label text-muted",children:"訂單編號"}),e.jsx("div",{className:"form-control-plaintext fw-bold",children:t.orderNo??t.id??"-"})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label text-muted",children:"客戶名稱"}),e.jsx("div",{className:"form-control-plaintext",children:t.customerName??"-"})]}),e.jsxs("div",{className:"col-md-12",children:[e.jsx("label",{className:"form-label text-muted",children:"路線"}),e.jsxs("div",{className:"form-control-plaintext",children:[t.pickupLocation??"-"," → ",t.destinationPort??"-"]})]})]})]}),e.jsx("hr",{className:"my-6"}),e.jsx("h5",{className:"mb-4",children:"選擇車輛與司機"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"form-label required",children:"車輛"}),i?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(z,{size:"sm",className:"me-2"}),e.jsx("span",{className:"text-muted",children:"載入車輛列表中..."})]}):p.length===0?e.jsxs("div",{className:"alert alert-warning mb-0",children:[e.jsx(f,{iconName:"information-5",className:"fs-2 me-2"}),"目前沒有可用的車輛"]}):e.jsxs("select",{className:"form-select",...g.getFieldProps("vehicleId"),required:!0,disabled:m,children:[e.jsx("option",{value:"",children:"請選擇車輛"}),p.map(o=>e.jsxs("option",{value:o.uuid,children:[o.plateNo," - ",o.type," ",o.brand&&o.model?`(${o.brand} ${o.model})`:"",o.status==="IN_USE"?" [使用中]":""]},o.uuid))]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"form-label required",children:"司機"}),b?e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(z,{size:"sm",className:"me-2"}),e.jsx("span",{className:"text-muted",children:"載入司機列表中..."})]}):x.length===0?e.jsxs("div",{className:"alert alert-warning mb-0",children:[e.jsx(f,{iconName:"information-5",className:"fs-2 me-2"}),"目前沒有可用的司機"]}):e.jsxs("select",{className:"form-select",...g.getFieldProps("driverId"),required:!0,disabled:m,children:[e.jsx("option",{value:"",children:"請選擇司機"}),x.map(o=>e.jsxs("option",{value:o.uuid,children:[o.name," - ",o.phone,o.currentVehicleId?` [車輛: ${o.currentVehiclePlateNo??"-"}]`:""]},o.uuid))]})]}),e.jsxs("div",{className:"alert alert-info mb-0",children:[e.jsx(f,{iconName:"information-5",className:"fs-2 me-2"}),e.jsxs("div",{children:[e.jsx("strong",{children:"提示："}),e.jsxs("ul",{className:"mb-0 mt-2",children:[e.jsx("li",{children:"請選擇可用的車輛和司機"}),e.jsx("li",{children:"指派成功後，訂單狀態將變更為「已指派」"}),e.jsx("li",{children:"司機將收到派單通知"})]})]})]})]}),e.jsxs(A.Footer,{children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:k,disabled:m,children:"取消"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:m||!g.values.vehicleId||!g.values.driverId,children:m?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2"}),"指派中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{iconName:"check",className:"fs-2 me-2"}),"確認指派"]})})]})]})})},ns=()=>{const s=_(),{alert:t,showAlert:a,Alert:r}=F(),[l,p]=n.useState(null),[N,x]=n.useState(!1),[v,i]=n.useState(0),h=n.useCallback(m=>{if(m.orderStatus!=="pending"&&m.orderStatus!=="CREATED"){a("只有待處理的訂單可以指派","warning");return}p(m),x(!0)},[a]),b=n.useCallback(()=>{x(!1),p(null),i(m=>m+1),a("指派成功","success")},[a]),u=n.useCallback(()=>{x(!1),p(null)},[]);return e.jsxs(G,{children:[t&&e.jsx(r,{message:t.message,type:t.type}),e.jsx(V,{title:"訂單指派",breadcrumbs:[{label:"TOM 運輸管理",href:"/tom"},{label:"訂單管理",href:"/tom/order/list",active:!1},{label:"訂單指派",active:!0}]}),e.jsx("div",{className:"flex-column-fluid",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header border-0 pt-6",children:[e.jsx("div",{className:"card-title",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(f,{iconName:"truck",className:"fs-2 me-2 text-primary"}),e.jsx("h3",{className:"mb-0",children:"待指派訂單"})]})}),e.jsx("div",{className:"card-toolbar",children:e.jsx("div",{className:"d-flex justify-content-end gap-2 flex-wrap",children:e.jsxs("button",{type:"button",className:"btn btn-light",onClick:()=>s("/tom/order/list"),children:[e.jsx(f,{iconName:"arrow-left",className:"fs-2"}),"返回列表"]})})})]}),e.jsx("div",{className:"card-body py-4",children:e.jsx(as,{showAlert:a,onAssign:h},v)})]})}),l&&e.jsx(rs,{open:N,order:l,onClose:u,onSuccess:b,showAlert:a})]})},I=[{title:"訂單管理",path:"/tom/order/overview",isSeparator:!1,isActive:!1},{title:"",path:"",isSeparator:!0,isActive:!1}],it=()=>e.jsxs(je,{children:[e.jsx(M,{path:"",element:e.jsx(be,{to:"overview",replace:!0})}),e.jsx(M,{path:"overview",element:e.jsxs(e.Fragment,{children:[e.jsx(O,{breadcrumbs:I,children:"訂單總覽"}),e.jsx(Me,{})]})}),e.jsx(M,{path:"list",element:e.jsxs(e.Fragment,{children:[e.jsx(O,{breadcrumbs:I,children:"訂單列表"}),e.jsx(Ae,{})]})}),e.jsx(M,{path:"create",element:e.jsxs(e.Fragment,{children:[e.jsx(O,{breadcrumbs:I,children:"建立訂單"}),e.jsx(Ee,{})]})}),e.jsx(M,{path:"assign",element:e.jsxs(e.Fragment,{children:[e.jsx(O,{breadcrumbs:I,children:"訂單指派"}),e.jsx(ns,{})]})}),e.jsx(M,{path:":id/detail",element:e.jsxs(e.Fragment,{children:[e.jsx(O,{breadcrumbs:I,children:"訂單詳情"}),e.jsx(Ye,{})]})}),e.jsx(M,{path:"report",element:e.jsx(e.Fragment,{children:e.jsx(O,{breadcrumbs:I,children:"訂單報表"})})})]});export{ns as AssignPage,Ee as CreatePage,Ye as DetailPage,Ae as ListPage,Me as OverviewPage,it as default};

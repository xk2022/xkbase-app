# ç™»å…¥ç‹€æ…‹æª¢æŸ¥æµç¨‹èªªæ˜

## ğŸ“ è¨ªå• `/dashboard` æ™‚çš„æª¢æŸ¥æµç¨‹

ç•¶æ‚¨è¨ªå• `http://localhost:5173/xkBase/dashboard` æ™‚ï¼Œç³»çµ±æœƒåœ¨**å¤šå€‹å±¤ç´š**æª¢æŸ¥ç™»å…¥ç‹€æ…‹ã€‚

---

## ğŸ” æª¢æŸ¥æµç¨‹åœ–

```
è¨ªå• /dashboard
    â†“
1. AppRoutes.tsx (ç¬¬ä¸€å±¤ï¼šè·¯ç”±å®ˆè¡›)
    â†“ æª¢æŸ¥ currentUser
    â”œâ”€ æœ‰ currentUser â†’ æ¸²æŸ“ PrivateRoutes
    â””â”€ æ²’æœ‰ currentUser â†’ å°èˆªåˆ° /auth
    â†“
2. App.tsx â†’ AuthInit (ç¬¬äºŒå±¤ï¼šåˆå§‹åŒ–æª¢æŸ¥)
    â†“ æª¢æŸ¥ localStorage (token + user)
    â”œâ”€ æœ‰èªè­‰ä¿¡æ¯ â†’ è¨­ç½® currentUser åˆ° Context
    â””â”€ æ²’æœ‰èªè­‰ä¿¡æ¯ â†’ æ¸…é™¤ç‹€æ…‹ä¸¦å°èˆªåˆ° /auth
    â†“
3. PrivateRoutes.tsx (å·²èªè­‰è·¯ç”±)
    â†“ æ¸²æŸ“ Dashboard é é¢
    â†“
4. http.ts (API å±¤ç´šï¼šè«‹æ±‚æ””æˆª)
    â†“ API è«‹æ±‚æ™‚è‡ªå‹•æ·»åŠ  token
    â†“ å¦‚æœæ”¶åˆ° 401/403 â†’ æ¸…é™¤èªè­‰ä¸¦å°èˆªåˆ° /auth
```

---

## ğŸ“‚ æª¢æŸ¥ç¨‹å¼ç¢¼ä½ç½®

### 1ï¸âƒ£ ç¬¬ä¸€å±¤æª¢æŸ¥ï¼šè·¯ç”±å®ˆè¡›ï¼ˆæœ€é‡è¦ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/app/routing/AppRoutes.tsx`

**æª¢æŸ¥é‚è¼¯**ï¼š
```typescript
const AppRoutes: FC = () => {
  const { currentUser } = useAuth()  // â† ç²å–ç•¶å‰ç”¨æˆ¶ç‹€æ…‹
  
  return (
    <BrowserRouter basename={BASE_URL}>
      <Routes>
        <Route element={<App />}>
          {/* æ ¹æ“š currentUser æ±ºå®šæ¸²æŸ“å“ªå€‹è·¯ç”±çµ„ä»¶ */}
          {currentUser ? ( // â† ç¬¬ä¸€å±¤æª¢æŸ¥ï¼šæ˜¯å¦æœ‰ç™»å…¥
            <>
              {/* å·²ç™»å…¥ï¼šæ¸²æŸ“å—ä¿è­·çš„è·¯ç”± */}
              <Route path='/*' element={<PrivateRoutes />} />
              <Route index element={<Navigate to='/dashboard' />} />
            </>
          ) : ( // æœªç™»å…¥
            <>
              {/* æœªç™»å…¥ï¼šåªé¡¯ç¤ºèªè­‰é é¢ï¼Œå…¶ä»–è·¯ç”±é‡å®šå‘åˆ° /auth */}
              <Route path='auth/*' element={<AuthPage />} />
              <Route path='*' element={<Navigate to='/auth' />} />
            </>
          )}
        </Route>
      </Routes>
    </BrowserRouter>
  )
}
```

**æª¢æŸ¥é»**ï¼š
- ğŸ“ **è¡Œ 42**: `const { currentUser } = useAuth()` - å¾ Context ç²å–ç”¨æˆ¶ç‹€æ…‹
- ğŸ“ **è¡Œ 54**: `{currentUser ? ...}` - æ¢ä»¶åˆ¤æ–·ï¼Œæ±ºå®šé¡¯ç¤ºå“ªå€‹è·¯ç”±

**å¦‚æœæ²’æœ‰ `currentUser`**ï¼š
- æ‰€æœ‰è·¯ç”±ï¼ˆåŒ…æ‹¬ `/dashboard`ï¼‰éƒ½æœƒè¢«é‡å®šå‘åˆ° `/auth`

---

### 2ï¸âƒ£ ç¬¬äºŒå±¤æª¢æŸ¥ï¼šåˆå§‹åŒ–æª¢æŸ¥

**æ–‡ä»¶ä½ç½®**ï¼š`src/app/modules/auth/core/Auth.tsx`

**çµ„ä»¶**ï¼š`AuthInit`

**æª¢æŸ¥é‚è¼¯**ï¼š
```typescript
const AuthInit: FC<WithChildren> = ({ children }) => {
  const { logout, setCurrentUser } = useAuth();
  
  useEffect(() => {
    // â† ç¬¬äºŒå±¤æª¢æŸ¥ï¼šå¾ localStorage è®€å–èªè­‰ä¿¡æ¯
    const token = authHelper.getToken();
    const user = authHelper.getAuth();
    
    // å¦‚æœæ²’æœ‰ token æˆ– userï¼Œæ¸…é™¤ç‹€æ…‹ä¸¦å°èˆªåˆ°ç™»å…¥é 
    if (!token || !user) {
      logout();
      const currentPath = window.location.pathname;
      const isAuthPage = currentPath === '/auth' || currentPath.startsWith('/auth/');
      if (!isAuthPage) {
        navigate('/auth', { replace: true }); // â† é‡å®šå‘åˆ°ç™»å…¥é 
      }
      return;
    }
    
    // æœ‰èªè­‰ä¿¡æ¯ï¼Œè¨­ç½®åˆ° Context
    setCurrentUser(user);
  }, [])
  
  return showSplashScreen ? <LayoutSplashScreen /> : <>{children}</>
}
```

**æª¢æŸ¥é»**ï¼š
- ğŸ“ **è¡Œ 58**: `authHelper.getToken()` - æª¢æŸ¥ localStorage ä¸­çš„ token
- ğŸ“ **è¡Œ 59**: `authHelper.getAuth()` - æª¢æŸ¥ localStorage ä¸­çš„ç”¨æˆ¶ä¿¡æ¯
- ğŸ“ **è¡Œ 62**: `if (!token || !user)` - å¦‚æœéƒ½æ²’æœ‰ï¼Œæ¸…é™¤èªè­‰ç‹€æ…‹
- ğŸ“ **è¡Œ 69**: `navigate('/auth', { replace: true })` - é‡å®šå‘åˆ°ç™»å…¥é 

**åœ¨å“ªè£¡è¢«èª¿ç”¨**ï¼š

**æ–‡ä»¶ä½ç½®**ï¼š`src/app/App.tsx`
```typescript
const App = () => {
  return (
    <AuthInit>  {/* â† é€™è£¡åŒ…è£¹äº†æ‰€æœ‰å­çµ„ä»¶ */}
      <Outlet />
    </AuthInit>
  )
}
```

---

### 3ï¸âƒ£ ç¬¬ä¸‰å±¤ï¼šContext åˆå§‹ç‹€æ…‹

**æ–‡ä»¶ä½ç½®**ï¼š`src/app/modules/auth/core/Auth.tsx`

**çµ„ä»¶**ï¼š`AuthProvider`

**æª¢æŸ¥é‚è¼¯**ï¼š
```typescript
const AuthProvider: FC<WithChildren> = ({ children }) => {
  // â† å¾ localStorage è®€å–åˆå§‹ç‹€æ…‹
  const [currentUser, setCurrentUser] = useState<UserModel | undefined>(() => {
    try {
      return authHelper.getAuth()  // â† åˆå§‹åŒ–æ™‚å°±è®€å–ç”¨æˆ¶ä¿¡æ¯
    } catch {
      return undefined
    }
  })
  
  // ...
}
```

**ä½œç”¨**ï¼š
- åœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚ï¼Œå¾ localStorage è®€å–ç”¨æˆ¶ä¿¡æ¯
- é¿å…åœ¨ `AppRoutes` æª¢æŸ¥æ™‚ `currentUser` ç‚º `undefined`

---

### 4ï¸âƒ£ API å±¤ç´šæª¢æŸ¥ï¼ˆè«‹æ±‚æ””æˆªï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/shared/api/http.ts`

**æª¢æŸ¥é‚è¼¯**ï¼š
```typescript
// Response Interceptorï¼šè™•ç† 401/403 éŒ¯èª¤
axios.interceptors.response.use(
  (r) => r,
  (err: AxiosError) => {
    const status = err.response?.status

    // å¦‚æœ API è¿”å› 401 æˆ– 403ï¼Œè¡¨ç¤ºèªè­‰å¤±æ•—
    if (isAuthError(status)) {  // 401 æˆ– 403
      clearAuthStorage()        // â† æ¸…é™¤èªè­‰ä¿¡æ¯
      redirectToLogin()         // â† å°èˆªåˆ°ç™»å…¥é 
    }

    return Promise.reject(err)
  }
)
```

**æª¢æŸ¥é»**ï¼š
- ğŸ“ **è¡Œ 112**: æª¢æŸ¥ API å›æ‡‰çš„ status code
- ğŸ“ **è¡Œ 114**: `if (isAuthError(status))` - å¦‚æœæ˜¯ 401/403
- ğŸ“ **è¡Œ 115**: `clearAuthStorage()` - æ¸…é™¤ localStorage
- ğŸ“ **è¡Œ 116**: `redirectToLogin()` - å°èˆªåˆ°ç™»å…¥é 

**ä½œç”¨**ï¼š
- å¦‚æœ token å·²éæœŸæˆ–ç„¡æ•ˆï¼ŒAPI æœƒè¿”å› 401
- è‡ªå‹•æ¸…é™¤èªè­‰ç‹€æ…‹ä¸¦å°èˆªåˆ°ç™»å…¥é 

---

## ğŸ”„ å®Œæ•´çš„æª¢æŸ¥æ™‚æ©Ÿ

### 1. **é é¢è¼‰å…¥æ™‚**

```
ç”¨æˆ¶è¨ªå• /dashboard
    â†“
AppRoutes æ¸²æŸ“
    â†“
æª¢æŸ¥ currentUser (ä¾†è‡ª Context)
    â”œâ”€ æœ‰ â†’ æ¸²æŸ“ PrivateRoutes
    â””â”€ æ²’æœ‰ â†’ é‡å®šå‘åˆ° /auth
    â†“
App.tsx â†’ AuthInit åŸ·è¡Œ
    â†“
æª¢æŸ¥ localStorage (token + user)
    â”œâ”€ æœ‰ â†’ è¨­ç½® currentUser åˆ° Context
    â””â”€ æ²’æœ‰ â†’ æ¸…é™¤ç‹€æ…‹ä¸¦å°èˆªåˆ° /auth
```

### 2. **è·¯ç”±åˆ‡æ›æ™‚**

```
ç”¨æˆ¶é»æ“Šå°èˆªé€£çµ
    â†“
React Router åˆ‡æ›è·¯ç”±
    â†“
AppRoutes é‡æ–°æª¢æŸ¥ currentUser
    â”œâ”€ æœ‰ â†’ å…è¨±è¨ªå•
    â””â”€ æ²’æœ‰ â†’ é‡å®šå‘åˆ° /auth
```

### 3. **API è«‹æ±‚æ™‚**

```
çµ„ä»¶ç™¼èµ· API è«‹æ±‚
    â†“
http.ts request interceptor
    â†“ è‡ªå‹•æ·»åŠ  Bearer token
API è«‹æ±‚
    â†“
http.ts response interceptor
    â†“
æª¢æŸ¥å›æ‡‰ status
    â”œâ”€ 200-299 â†’ æ­£å¸¸è™•ç†
    â””â”€ 401/403 â†’ æ¸…é™¤èªè­‰ä¸¦å°èˆªåˆ° /auth
```

---

## ğŸ“Š æª¢æŸ¥é‚è¼¯ç¸½çµ

| æª¢æŸ¥å±¤ç´š | æ–‡ä»¶ä½ç½® | æª¢æŸ¥å…§å®¹ | è§¸ç™¼æ™‚æ©Ÿ |
|---------|---------|---------|---------|
| **1. è·¯ç”±å®ˆè¡›** | `AppRoutes.tsx` | `currentUser` (Context) | æ¯æ¬¡è·¯ç”±è®ŠåŒ– |
| **2. åˆå§‹åŒ–æª¢æŸ¥** | `Auth.tsx` (AuthInit) | localStorage (token + user) | çµ„ä»¶æ›è¼‰æ™‚ |
| **3. Context åˆå§‹åŒ–** | `Auth.tsx` (AuthProvider) | localStorage (user) | æ‡‰ç”¨å•Ÿå‹•æ™‚ |
| **4. API æ””æˆª** | `http.ts` | API å›æ‡‰ status | æ¯æ¬¡ API è«‹æ±‚ |

---

## ğŸ”§ å¦‚ä½•èª¿è©¦

### åœ¨ç€è¦½å™¨ Console ä¸­æª¢æŸ¥

```javascript
// 1. æª¢æŸ¥ localStorage
console.log('AUTH_USER:', localStorage.getItem('AUTH_USER'))
console.log('AUTH_TOKEN:', localStorage.getItem('AUTH_TOKEN'))

// 2. æª¢æŸ¥ Context ç‹€æ…‹ï¼ˆéœ€è¦åœ¨ React DevTools ä¸­ï¼‰
// æˆ–è€…åœ¨çµ„ä»¶ä¸­æ·»åŠ  console.log

// 3. æª¢æŸ¥ç•¶å‰è·¯å¾‘
console.log('Current path:', window.location.pathname)
```

### æ·»åŠ èª¿è©¦æ—¥èªŒ

åœ¨ `AppRoutes.tsx` ä¸­æ·»åŠ ï¼š
```typescript
const AppRoutes: FC = () => {
  const { currentUser } = useAuth()
  
  console.log('[AppRoutes] currentUser:', currentUser) // â† æ·»åŠ é€™è¡Œ
  
  return (
    // ...
  )
}
```

åœ¨ `AuthInit` ä¸­æ·»åŠ ï¼š
```typescript
useEffect(() => {
  const token = authHelper.getToken();
  const user = authHelper.getAuth();
  
  console.log('[AuthInit] token:', token)  // â† æ·»åŠ é€™è¡Œ
  console.log('[AuthInit] user:', user)    // â† æ·»åŠ é€™è¡Œ
  
  // ...
}, [])
```

---

## â“ å¸¸è¦‹å•é¡Œ

### Q: ç‚ºä»€éº¼æœƒè·³å›ç™»å…¥é ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š

1. **localStorage ä¸­æ²’æœ‰èªè­‰ä¿¡æ¯**
   - `AUTH_USER` æˆ– `AUTH_TOKEN` ä¸å­˜åœ¨
   - æª¢æŸ¥ï¼šæ‰“é–‹ DevTools â†’ Application â†’ Local Storage

2. **èªè­‰ä¿¡æ¯æ ¼å¼éŒ¯èª¤**
   - `AUTH_USER` çš„ JSON è§£æå¤±æ•—
   - æª¢æŸ¥ï¼šConsole æ˜¯å¦æœ‰è§£æéŒ¯èª¤

3. **Token éæœŸ**
   - API è¿”å› 401ï¼Œè§¸ç™¼ response interceptor
   - æª¢æŸ¥ï¼šNetwork æ¨™ç±¤æŸ¥çœ‹ API å›æ‡‰

4. **Context ç‹€æ…‹æœªæ›´æ–°**
   - `currentUser` åœ¨ Context ä¸­ç‚º `undefined`
   - æª¢æŸ¥ï¼šReact DevTools æŸ¥çœ‹ Context ç‹€æ…‹

### Q: å¦‚ä½•ç¢ºä¿ç™»å…¥ç‹€æ…‹æŒä¹…åŒ–ï¼Ÿ

1. **ç¢ºèª localStorage æ­£ç¢ºä¿å­˜**
   ```javascript
   // ç™»å…¥å¾Œæª¢æŸ¥
   console.log(localStorage.getItem('AUTH_USER'))
   console.log(localStorage.getItem('AUTH_TOKEN'))
   ```

2. **ç¢ºèª AuthProvider åˆå§‹åŒ–æ­£ç¢º**
   - `AuthProvider` æ‡‰è©²å¾ localStorage è®€å–åˆå§‹ç‹€æ…‹

3. **ç¢ºèª AuthInit ä¸æœƒæ¸…é™¤æœ‰æ•ˆèªè­‰**
   - æª¢æŸ¥ `getToken()` å’Œ `getAuth()` æ˜¯å¦æ­£ç¢ºè®€å–

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- **è·¯ç”±é…ç½®**: `src/app/routing/AppRoutes.tsx`
- **ç§æœ‰è·¯ç”±**: `src/app/routing/PrivateRoutes.tsx`
- **èªè­‰ Context**: `src/app/modules/auth/core/Auth.tsx`
- **èªè­‰å·¥å…·**: `src/app/modules/auth/core/AuthHelpers.ts`
- **HTTP æ””æˆª**: `src/shared/api/http.ts`
- **App æ ¹çµ„ä»¶**: `src/app/App.tsx`

---

**æœ€å¾Œæ›´æ–°**: 2025-01-09

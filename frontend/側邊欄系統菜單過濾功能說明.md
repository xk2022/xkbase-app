# 側邊欄系統菜單過濾功能說明

## 📋 功能概述

側邊欄菜單現在會根據**選中的系統**和**用戶權限**動態顯示功能，只顯示當前系統下的相關功能。

---

## 🎯 實現邏輯

### 1. 系統選擇

**位置**：側邊欄頂部的下拉選單

- 顯示所有啟用的系統列表
- 選擇系統後，菜單會自動更新
- 當前選中的系統 UUID 保存在 `SystemContext` 中

### 2. 菜單過濾規則

菜單項會根據以下規則過濾：

1. **系統代碼匹配**
   - 每個菜單區塊和菜單項都對應一個系統代碼（如 `UPMS`, `TOM`, `FMS`, `ADM`）
   - 只有選中對應系統時才顯示

2. **權限檢查**
   - 每個菜單項可以指定所需的權限（如 `upms.user.read`）
   - 只有在用戶擁有該權限時才顯示

3. **層級過濾**
   - 如果子菜單項全部被過濾，父菜單項也會隱藏
   - 如果區塊內所有菜單項都被過濾，區塊標題也會隱藏

### 3. 開發環境特殊處理

- **TEST 帳號**（`test`, `demo`, `mock`）：如果屬於該系統，即使沒有具體權限也會顯示（用於測試）
- **開發環境**：同樣的寬鬆策略，方便開發測試

---

## 📁 文件結構

### 核心文件

1. **`menuConfig.tsx`** - 菜單配置
   - 定義所有菜單項的結構
   - 指定每個菜單項對應的系統和權限

2. **`SidebarMenuMain.tsx`** - 菜單主組件
   - 使用配置和過濾邏輯渲染菜單
   - 根據系統和權限過濾菜單項

3. **`SystemContext.tsx`** - 系統上下文
   - 管理系統列表和選中的系統
   - 提供權限檢查方法

---

## 🔧 配置說明

### 菜單配置結構

```typescript
{
  sectionTitle: 'UPMS 權限管理',      // 區塊標題
  requiredSystem: 'UPMS',             // 區塊級別的系統要求
  requiredPermission: 'upms.*',       // 區塊級別的權限要求（可選）
  items: [
    {
      type: 'submenu',                // 'item' 或 'submenu'
      to: '/upms/user',
      title: '使用者管理',
      requiredSystem: 'UPMS',         // 菜單項級別的系統要求
      requiredPermission: 'upms.user.read', // 菜單項級別的權限要求
      children: [
        {
          type: 'item',
          to: '/upms/user/list',
          title: '使用者列表',
          requiredPermission: 'upms.user.read', // 子菜單項的權限要求
        }
      ]
    }
  ]
}
```

### 系統代碼對應

| 系統代碼 | 系統名稱 | 主要功能 |
|---------|---------|---------|
| **UPMS** | 權限管理系統 | 用戶、角色、權限、系統管理 |
| **TOM** | 訂單管理系統 | 訂單、貨櫃、任務管理 |
| **FMS** | 車隊管理系統 | 車輛、司機、派遣管理 |
| **ADM** | 系統設定 | 字典檔、參數、日誌管理 |

### 權限命名規範

權限命名格式：`{系統代碼}.{模組}.{操作}`

**範例**：
- `upms.user.read` - UPMS 系統下用戶模組的讀取權限
- `upms.user.create` - UPMS 系統下用戶模組的創建權限
- `tom.order.read` - TOM 系統下訂單模組的讀取權限
- `fms.vehicle.read` - FMS 系統下車輛模組的讀取權限

---

## 🧪 測試方式

### 1. 使用 TEST 帳號測試

1. 使用 TEST 帳號登入（`test` / `1234`）
2. 在下拉選單中選擇不同系統
3. 觀察菜單是否根據系統變化

### 2. 權限測試

**注意**：當前 TEST 帳號在開發環境下會顯示所有菜單（為了方便測試）

如果要測試權限過濾：
1. 在後端配置用戶權限
2. 登入真實帳號
3. 選擇對應系統
4. 觀察菜單是否根據權限過濾

### 3. 調試方法

在瀏覽器 Console 中檢查：

```javascript
// 檢查當前選中的系統
// 在 React DevTools 中查看 SystemContext 的值

// 或添加 console.log
console.log('選中系統:', selectedSystemCode)
console.log('系統權限:', currentSystemPermissions)
```

---

## 🔍 工作原理

### 流程圖

```
用戶選擇系統
    ↓
SystemContext 更新 selectedSystemUuid
    ↓
從 currentUser.systemDTOs 中找到對應系統的權限
    ↓
SidebarMenuMain 使用過濾邏輯
    ↓
根據系統代碼和權限過濾 menuConfig
    ↓
渲染過濾後的菜單
```

### 過濾邏輯

```typescript
// 1. 檢查區塊級別
if (section.requiredSystem && !hasSystem(section.requiredSystem)) {
  return null // 不屬於該系統，隱藏整個區塊
}

// 2. 檢查菜單項級別
if (item.requiredSystem && !hasSystem(item.requiredSystem)) {
  return null // 不屬於該系統，隱藏菜單項
}

// 3. 檢查權限
if (item.requiredPermission && !hasSystemPermission(item.requiredPermission)) {
  return null // 沒有權限，隱藏菜單項
}

// 4. 檢查子菜單
if (item.children.length === 0) {
  return null // 沒有可顯示的子菜單，隱藏父菜單
}
```

---

## 📝 添加新菜單項

### 步驟

1. **在 `menuConfig.tsx` 中添加配置**

```typescript
{
  type: 'submenu',
  to: '/your-module',
  title: '您的模組',
  requiredSystem: 'YOUR_SYSTEM', // 指定系統代碼
  children: [
    {
      type: 'item',
      to: '/your-module/list',
      title: '列表',
      requiredPermission: 'your.system.read', // 指定權限
    }
  ]
}
```

2. **確保後端有對應的權限**
   - 權限名稱需要與配置中的 `requiredPermission` 一致

3. **測試**
   - 選擇對應系統
   - 確保用戶有相應權限
   - 驗證菜單正確顯示

---

## ⚠️ 注意事項

### 1. 系統代碼大小寫

- 系統代碼在比較時會自動轉為大寫
- 配置中使用 `UPMS`、`TOM` 等，系統中的 `code` 也應該是大寫

### 2. 權限匹配

- 權限名稱需要**完全匹配**
- 區分大小寫
- 建議使用統一命名規範

### 3. 測試帳號行為

- TEST 帳號在開發環境下會顯示所有屬於該系統的菜單
- 這僅用於開發測試，生產環境需要真實的權限配置

### 4. 系統 UUID 匹配

- 用戶的 `systemDTOs` 中的 `systemUuid` 需要與系統列表中的 `id` 匹配
- 如果不匹配，無法獲取權限，菜單將被過濾

---

## 🔄 後續優化建議

1. **權限快取**
   - 考慮將權限列表快取，減少重複計算

2. **權限繼承**
   - 實現角色權限繼承機制

3. **動態菜單**
   - 根據後端配置動態生成菜單（目前是靜態配置）

4. **權限預覽**
   - 在開發環境提供權限預覽工具

---

## 📞 相關文件

- **菜單配置**: `src/_metronic/layout/components/sidebar/sidebar-menu/menuConfig.tsx`
- **菜單組件**: `src/_metronic/layout/components/sidebar/sidebar-menu/SidebarMenuMain.tsx`
- **系統上下文**: `src/app/pages/common/SystemContext.tsx`
- **側邊欄**: `src/_metronic/layout/components/sidebar/sidebar-menu/SidebarMenu.tsx`

---

**最後更新**: 2025-01-09  
**版本**: 1.0.0

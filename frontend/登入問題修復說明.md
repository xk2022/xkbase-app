# ç™»å…¥å•é¡Œä¿®å¾©èªªæ˜

## ğŸ”§ ä¿®å¾©çš„å•é¡Œ

**å•é¡Œæè¿°**ï¼šç™»å…¥å¾Œæœƒè‡ªå‹•è·³å›ç™»å…¥é é¢

## ğŸ› å•é¡ŒåŸå› 

1. **é¡å‹ä¸åŒ¹é…**ï¼š
   - `processUserLogin` å’Œ `setAuth` å‡½æ•¸æœŸæœ› `Auth` é¡å‹ï¼ˆæœ‰ `accessToken` å­—æ®µï¼‰
   - ä½†å¾ `tryDevLogin` è¿”å›çš„æ˜¯ `UserModel` é¡å‹ï¼ˆæœ‰ `token` å­—æ®µï¼‰
   - å°è‡´ token æ²’æœ‰æ­£ç¢ºä¿å­˜åˆ° localStorage

2. **èªè­‰ç‹€æ…‹æœªæ­£ç¢ºåˆå§‹åŒ–**ï¼š
   - `AuthInit` åœ¨æª¢æŸ¥èªè­‰ç‹€æ…‹æ™‚ï¼Œå¦‚æœæ²’æœ‰ token æˆ– userï¼Œæœƒæ¸…é™¤ç‹€æ…‹ä¸¦å°èˆª
   - ç”±æ–¼ token æ²’æœ‰æ­£ç¢ºä¿å­˜ï¼Œå°è‡´åˆå§‹åŒ–æ™‚èªç‚ºæœªç™»å…¥

3. **è·¯ç”±åˆ‡æ›æ™‚æ©Ÿå•é¡Œ**ï¼š
   - ç™»å…¥å¾Œè¨­ç½®äº† `currentUser`ï¼Œä½†å¯èƒ½åœ¨æŸå€‹æ™‚é–“é»è·¯ç”±æª¢æŸ¥æ™‚é‚„æ²’æœ‰æ›´æ–°
   - å°è‡´è·¯ç”±åˆ‡æ›åˆ°æœªç™»å…¥ç‹€æ…‹

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. ä¿®å¾©é¡å‹å…¼å®¹æ€§

**æ–‡ä»¶**ï¼š`src/app/modules/auth/core/AuthHelpers.ts`

- ä¿®æ”¹ `setAuth` å‡½æ•¸ï¼Œæ”¯æŒ `Auth` å’Œ `UserModel` å…©ç¨®é¡å‹
- è‡ªå‹•æª¢æ¸¬ `accessToken` æˆ– `token` å­—æ®µ
- ä¿®æ”¹ `processUserLogin` æ”¯æŒå…©ç¨®é¡å‹

```typescript
// ä¿®å¾©å‰
const setAuth = (auth: Auth) => {
  localStorage.setItem(AUTH_TOKEN_STORAGE_KEY, auth.accessToken)
}

// ä¿®å¾©å¾Œ
const setAuth = (auth: Auth | UserModel) => {
  const token = 'accessToken' in auth ? auth.accessToken : auth.token
  if (token) {
    localStorage.setItem(AUTH_TOKEN_STORAGE_KEY, token)
  }
}
```

### 2. å„ªåŒ– AuthInit é‚è¼¯

**æ–‡ä»¶**ï¼š`src/app/modules/auth/core/Auth.tsx`

- å„ªåŒ–å°èˆªé‚è¼¯ï¼Œé¿å…ä¸å¿…è¦çš„é‡å®šå‘
- åªåœ¨çµ„ä»¶æ›è¼‰æ™‚åŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–æª¢æŸ¥
- æ”¹å–„éŒ¯èª¤è™•ç†

```typescript
useEffect(() => {
  const token = authHelper.getToken();
  const user = authHelper.getAuth();
  
  if (!token || !user) {
    logout();
    const currentPath = window.location.pathname;
    const isAuthPage = currentPath === '/auth' || currentPath.startsWith('/auth/');
    if (!isAuthPage) {
      navigate('/auth', { replace: true });
    }
    setShowSplashScreen(false);
    return;
  }
  
  setCurrentUser(user);
  setShowSplashScreen(false);
}, []) // åªåœ¨çµ„ä»¶æ›è¼‰æ™‚åŸ·è¡Œä¸€æ¬¡
```

### 3. ç§»é™¤æ‰‹å‹•å°èˆª

**æ–‡ä»¶**ï¼š`src/app/modules/auth/components/Login.tsx`

- ç§»é™¤æ‰‹å‹• `navigate` èª¿ç”¨
- ä¾è³´ `AppRoutes` æ ¹æ“š `currentUser` è‡ªå‹•åˆ‡æ›è·¯ç”±
- ç¢ºä¿å…ˆè¨­ç½® localStorageï¼Œå†è¨­ç½® Context

```typescript
// ä¿®å¾©å‰
processUserLogin(mockUser)
setCurrentUser(mockUser)
navigate('/dashboard', { replace: true })

// ä¿®å¾©å¾Œ
processUserLogin(mockUser)
setCurrentUser(mockUser)
// AppRoutes æœƒæ ¹æ“š currentUser è‡ªå‹•å°èˆªåˆ° /dashboard
```

## ğŸ” ä¿®å¾©å¾Œçš„æµç¨‹

### æ­£å¸¸ç™»å…¥æµç¨‹

1. ç”¨æˆ¶è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ä¸¦æäº¤
2. **TEST å¸³è™Ÿ**ï¼š
   - `tryDevLogin` è¿”å› `UserModel`
   - `processUserLogin` ä¿å­˜åˆ° localStorageï¼ˆåŒ…å« tokenï¼‰
   - `setCurrentUser` æ›´æ–° Context
3. **ä¸€èˆ¬å¸³è™Ÿ**ï¼š
   - `signin` èª¿ç”¨ API ç²å–ç”¨æˆ¶ä¿¡æ¯
   - `processUserLogin` ä¿å­˜åˆ° localStorage
   - `setCurrentUser` æ›´æ–° Context
4. `AppRoutes` æª¢æ¸¬åˆ° `currentUser` æ›´æ–°ï¼Œè‡ªå‹•åˆ‡æ›åˆ°å·²ç™»å…¥è·¯ç”±
5. é‡å®šå‘åˆ° `/dashboard`

### åˆå§‹åŒ–æµç¨‹

1. `AuthInit` çµ„ä»¶æ›è¼‰
2. å¾ localStorage è®€å– token å’Œ user
3. å¦‚æœæœ‰èªè­‰ä¿¡æ¯ï¼Œè¨­ç½®åˆ° Context
4. å¦‚æœæ²’æœ‰èªè­‰ä¿¡æ¯ï¼Œå°èˆªåˆ°ç™»å…¥é ï¼ˆåƒ…åœ¨éç™»å…¥é æ™‚ï¼‰

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

1. **æ¸…é™¤ç€è¦½å™¨æ•¸æ“š**ï¼š
   - æ‰“é–‹é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰
   - Application â†’ Local Storage â†’ æ¸…é™¤æ‰€æœ‰é …ç›®

2. **æ¸¬è©¦ TEST å¸³è™Ÿç™»å…¥**ï¼š
   - å¸³è™Ÿï¼š`test`
   - å¯†ç¢¼ï¼š`1234`
   - é æœŸï¼šç™»å…¥æˆåŠŸï¼Œè‡ªå‹•è·³è½‰åˆ° `/dashboard`

3. **æª¢æŸ¥ localStorage**ï¼š
   - `AUTH_USER` æ‡‰è©²æœ‰ç”¨æˆ¶ä¿¡æ¯
   - `AUTH_TOKEN` æ‡‰è©²æœ‰ token å€¼

4. **æª¢æŸ¥ Console**ï¼š
   - ä¸æ‡‰è©²æœ‰èªè­‰éŒ¯èª¤
   - æ‡‰è©²çœ‹åˆ° `[Mock] ä½¿ç”¨ Mock æ•¸æ“šï¼ˆTEST å¸³è™Ÿï¼‰`ï¼ˆå¦‚æœä½¿ç”¨ TEST å¸³è™Ÿï¼‰

5. **åˆ·æ–°é é¢**ï¼š
   - åˆ·æ–°å¾Œæ‡‰è©²ä¿æŒç™»å…¥ç‹€æ…‹
   - ä¸æ‡‰è©²è·³å›ç™»å…¥é 

## ğŸ“ æ³¨æ„äº‹é …

1. **é¡å‹å…¼å®¹æ€§**ï¼š
   - å¾ŒçºŒæ–°å¢çš„èªè­‰ç›¸é—œä»£ç¢¼ï¼Œéœ€è¦ç¢ºä¿é¡å‹å…¼å®¹
   - å¦‚æœå¾Œç«¯è¿”å›çš„æ ¼å¼æ”¹è®Šï¼Œéœ€è¦åŒæ­¥æ›´æ–°é¡å‹å®šç¾©

2. **è·¯ç”±å®ˆè¡›**ï¼š
   - `AppRoutes` æ ¹æ“š `currentUser` å‹•æ…‹æ±ºå®šè·¯ç”±
   - ç¢ºä¿æ‰€æœ‰éœ€è¦èªè­‰çš„è·¯ç”±éƒ½åœ¨ `PrivateRoutes` ä¸­

3. **èªè­‰ç‹€æ…‹åŒæ­¥**ï¼š
   - localStorage å’Œ Context éƒ½éœ€è¦åŒæ­¥æ›´æ–°
   - é †åºï¼šå…ˆ localStorageï¼Œå† Context

## ğŸ”„ å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

å¦‚æœä¿®å¾©å¾Œå•é¡Œä»ç„¶å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ï¼š

1. **ç€è¦½å™¨ Console**ï¼š
   - æŸ¥çœ‹æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
   - æª¢æŸ¥æ˜¯å¦æœ‰ API è«‹æ±‚å¤±æ•—

2. **localStorage**ï¼š
   - æª¢æŸ¥ `AUTH_USER` å’Œ `AUTH_TOKEN` æ˜¯å¦å­˜åœ¨
   - ç¢ºèªæ•¸æ“šæ ¼å¼æ˜¯å¦æ­£ç¢º

3. **React DevTools**ï¼š
   - æª¢æŸ¥ `AuthContext` ä¸­çš„ `currentUser` æ˜¯å¦æ­£ç¢ºè¨­ç½®
   - ç¢ºèªç‹€æ…‹æ›´æ–°æ˜¯å¦è§¸ç™¼äº†é‡æ–°æ¸²æŸ“

4. **Network æ¨™ç±¤**ï¼š
   - æª¢æŸ¥æ˜¯å¦æœ‰æœªæˆæ¬Šçš„ API è«‹æ±‚ï¼ˆ401 éŒ¯èª¤ï¼‰
   - ç¢ºèª token æ˜¯å¦æ­£ç¢ºæ·»åŠ åˆ°è«‹æ±‚é ­

---

**ä¿®å¾©æ—¥æœŸ**: 2025-01-09  
**å½±éŸ¿ç¯„åœ**: èªè­‰ç³»çµ±ã€ç™»å…¥æµç¨‹
